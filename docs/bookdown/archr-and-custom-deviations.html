<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>15.2 ArchR and Custom Deviations | ArchR: Robust and scaleable analysis of single-cell chromatin accessibility data.</title>
  <meta name="description" content="A guide to ArchR" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="15.2 ArchR and Custom Deviations | ArchR: Robust and scaleable analysis of single-cell chromatin accessibility data." />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A guide to ArchR" />
  <meta name="github-repo" content="GreenleafLab/ArchR" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="15.2 ArchR and Custom Deviations | ArchR: Robust and scaleable analysis of single-cell chromatin accessibility data." />
  
  <meta name="twitter:description" content="A guide to ArchR" />
  

<meta name="author" content="Jeffrey Granja and Ryan Corces" />


<meta name="date" content="2025-02-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
<link rel="prev" href="motif-deviations.html"/>
<link rel="next" href="footprinting-with-archr.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="../index.html">Back to ArchR Home</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><img src="images/ArchR_Logo_Integrated.png" alt="" width="200"></a></li>
<li class="chapter" data-level="1" data-path="debugging-and-troubleshooting-in-archr.html"><a href="debugging-and-troubleshooting-in-archr.html"><i class="fa fa-check"></i><b>1</b> Debugging and Troubleshooting in ArchR</a></li>
<li class="chapter" data-level="2" data-path="manage-archrs-dependencies.html"><a href="manage-archrs-dependencies.html"><i class="fa fa-check"></i><b>2</b> Manage ArchR’s Dependencies</a>
<ul>
<li class="chapter" data-level="2.1" data-path="using-renv-to-manage-dependencies.html"><a href="using-renv-to-manage-dependencies.html"><i class="fa fa-check"></i><b>2.1</b> Using renv to manage dependencies</a></li>
<li class="chapter" data-level="2.2" data-path="other-environment-managers.html"><a href="other-environment-managers.html"><i class="fa fa-check"></i><b>2.2</b> Other environment managers</a></li>
<li class="chapter" data-level="2.3" data-path="using-docker-for-pre-compiled-environment-setup.html"><a href="using-docker-for-pre-compiled-environment-setup.html"><i class="fa fa-check"></i><b>2.3</b> Using Docker for pre-compiled environment setup</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="getting-started-with-archr.html"><a href="getting-started-with-archr.html"><i class="fa fa-check"></i><b>3</b> Getting Started with ArchR</a>
<ul>
<li class="chapter" data-level="3.1" data-path="a-brief-primer-on-atac-seq-terminology.html"><a href="a-brief-primer-on-atac-seq-terminology.html"><i class="fa fa-check"></i><b>3.1</b> A Brief Primer on ATAC-seq Terminology</a></li>
<li class="chapter" data-level="3.2" data-path="why-use-archr.html"><a href="why-use-archr.html"><i class="fa fa-check"></i><b>3.2</b> Why use ArchR?</a></li>
<li class="chapter" data-level="3.3" data-path="what-is-an-arrow-file-archrproject.html"><a href="what-is-an-arrow-file-archrproject.html"><i class="fa fa-check"></i><b>3.3</b> What is an Arrow file / <code>ArchRProject</code>?</a></li>
<li class="chapter" data-level="3.4" data-path="input-file-types-in-archr.html"><a href="input-file-types-in-archr.html"><i class="fa fa-check"></i><b>3.4</b> Input File Types in ArchR</a></li>
<li class="chapter" data-level="3.5" data-path="getting-set-up.html"><a href="getting-set-up.html"><i class="fa fa-check"></i><b>3.5</b> Getting Set Up</a></li>
<li class="chapter" data-level="3.6" data-path="creating-arrow-files.html"><a href="creating-arrow-files.html"><i class="fa fa-check"></i><b>3.6</b> Creating Arrow Files</a></li>
<li class="chapter" data-level="3.7" data-path="per-cell-quality-control.html"><a href="per-cell-quality-control.html"><i class="fa fa-check"></i><b>3.7</b> Per-cell Quality Control</a></li>
<li class="chapter" data-level="3.8" data-path="using-bam-files-for-arrow-file-creation.html"><a href="using-bam-files-for-arrow-file-creation.html"><i class="fa fa-check"></i><b>3.8</b> Using BAM files for Arrow File creation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="doublet-inference-with-archr.html"><a href="doublet-inference-with-archr.html"><i class="fa fa-check"></i><b>4</b> Doublet Inference with ArchR</a>
<ul>
<li class="chapter" data-level="4.1" data-path="how-does-doublet-identification-work-in-archr.html"><a href="how-does-doublet-identification-work-in-archr.html"><i class="fa fa-check"></i><b>4.1</b> How does doublet identification work in ArchR?</a></li>
<li class="chapter" data-level="4.2" data-path="inferring-scatac-seq-doublets-with-archr.html"><a href="inferring-scatac-seq-doublets-with-archr.html"><i class="fa fa-check"></i><b>4.2</b> Inferring scATAC-seq Doublets with ArchR</a></li>
<li class="chapter" data-level="4.3" data-path="using-demuxlet-with-archr.html"><a href="using-demuxlet-with-archr.html"><i class="fa fa-check"></i><b>4.3</b> Using <em>demuxlet</em> with ArchR</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="creating-an-archrproject.html"><a href="creating-an-archrproject.html"><i class="fa fa-check"></i><b>5</b> Creating an ArchRProject</a>
<ul>
<li class="chapter" data-level="5.1" data-path="creating-an-archrproject-1.html"><a href="creating-an-archrproject-1.html"><i class="fa fa-check"></i><b>5.1</b> Creating An ArchRProject</a></li>
<li class="chapter" data-level="5.2" data-path="manipulating-an-archrproject.html"><a href="manipulating-an-archrproject.html"><i class="fa fa-check"></i><b>5.2</b> Manipulating An ArchRProject</a></li>
<li class="chapter" data-level="5.3" data-path="plotting-sample-statistics-from-an-archrproject.html"><a href="plotting-sample-statistics-from-an-archrproject.html"><i class="fa fa-check"></i><b>5.3</b> Plotting Sample Statistics from an ArchRProject</a></li>
<li class="chapter" data-level="5.4" data-path="plotting-sample-fragment-size-distribution-and-tss-enrichment-profiles..html"><a href="plotting-sample-fragment-size-distribution-and-tss-enrichment-profiles..html"><i class="fa fa-check"></i><b>5.4</b> Plotting Sample Fragment Size Distribution and TSS Enrichment Profiles.</a></li>
<li class="chapter" data-level="5.5" data-path="saving-and-loading-an-archrproject.html"><a href="saving-and-loading-an-archrproject.html"><i class="fa fa-check"></i><b>5.5</b> Saving and Loading an <code>ArchRProject</code></a></li>
<li class="chapter" data-level="5.6" data-path="filtering-doublets-from-an-archrproject.html"><a href="filtering-doublets-from-an-archrproject.html"><i class="fa fa-check"></i><b>5.6</b> Filtering Doublets from an ArchRProject</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="dimensionality-reduction-with-archr.html"><a href="dimensionality-reduction-with-archr.html"><i class="fa fa-check"></i><b>6</b> Dimensionality Reduction with ArchR</a>
<ul>
<li class="chapter" data-level="6.1" data-path="archrs-lsi-implementation.html"><a href="archrs-lsi-implementation.html"><i class="fa fa-check"></i><b>6.1</b> ArchR’s LSI Implementation</a></li>
<li class="chapter" data-level="6.2" data-path="iterative-latent-semantic-indexing-lsi.html"><a href="iterative-latent-semantic-indexing-lsi.html"><i class="fa fa-check"></i><b>6.2</b> Iterative Latent Semantic Indexing (LSI)</a></li>
<li class="chapter" data-level="6.3" data-path="estimated-lsi.html"><a href="estimated-lsi.html"><i class="fa fa-check"></i><b>6.3</b> Estimated LSI</a></li>
<li class="chapter" data-level="6.4" data-path="batch-effect-correction-wtih-harmony.html"><a href="batch-effect-correction-wtih-harmony.html"><i class="fa fa-check"></i><b>6.4</b> Batch Effect Correction wtih Harmony</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="clustering-with-archr.html"><a href="clustering-with-archr.html"><i class="fa fa-check"></i><b>7</b> Clustering with ArchR</a>
<ul>
<li class="chapter" data-level="7.1" data-path="clustering-using-seurats-findclusters-function.html"><a href="clustering-using-seurats-findclusters-function.html"><i class="fa fa-check"></i><b>7.1</b> Clustering using Seurat’s <code>FindClusters()</code> function</a></li>
<li class="chapter" data-level="7.2" data-path="clustering-using-scran.html"><a href="clustering-using-scran.html"><i class="fa fa-check"></i><b>7.2</b> Clustering using <code>scran</code></a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="single-cell-embeddings.html"><a href="single-cell-embeddings.html"><i class="fa fa-check"></i><b>8</b> Single-cell Embeddings</a>
<ul>
<li class="chapter" data-level="8.1" data-path="uniform-manifold-approximation-and-projection-umap.html"><a href="uniform-manifold-approximation-and-projection-umap.html"><i class="fa fa-check"></i><b>8.1</b> Uniform Manifold Approximation and Projection (UMAP)</a></li>
<li class="chapter" data-level="8.2" data-path="t-stocastic-neighbor-embedding-t-sne.html"><a href="t-stocastic-neighbor-embedding-t-sne.html"><i class="fa fa-check"></i><b>8.2</b> t-Stocastic Neighbor Embedding (t-SNE)</a></li>
<li class="chapter" data-level="8.3" data-path="dimensionality-reduction-after-harmony.html"><a href="dimensionality-reduction-after-harmony.html"><i class="fa fa-check"></i><b>8.3</b> Dimensionality Reduction After Harmony</a></li>
<li class="chapter" data-level="8.4" data-path="highlighting-specific-cells-on-an-embedding.html"><a href="highlighting-specific-cells-on-an-embedding.html"><i class="fa fa-check"></i><b>8.4</b> Highlighting specific cells on an embedding</a></li>
<li class="chapter" data-level="8.5" data-path="importing-an-embedding-from-external-software.html"><a href="importing-an-embedding-from-external-software.html"><i class="fa fa-check"></i><b>8.5</b> Importing an embedding from external software</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="gene-scores-and-marker-genes-with-archr.html"><a href="gene-scores-and-marker-genes-with-archr.html"><i class="fa fa-check"></i><b>9</b> Gene Scores and Marker Genes with ArchR</a>
<ul>
<li class="chapter" data-level="9.1" data-path="calculating-gene-scores-in-archr.html"><a href="calculating-gene-scores-in-archr.html"><i class="fa fa-check"></i><b>9.1</b> Calculating Gene Scores in ArchR</a></li>
<li class="chapter" data-level="9.2" data-path="identification-of-marker-features.html"><a href="identification-of-marker-features.html"><i class="fa fa-check"></i><b>9.2</b> Identification of Marker Features</a></li>
<li class="chapter" data-level="9.3" data-path="identifying-marker-genes.html"><a href="identifying-marker-genes.html"><i class="fa fa-check"></i><b>9.3</b> Identifying Marker Genes</a></li>
<li class="chapter" data-level="9.4" data-path="visualizing-marker-genes-on-an-embedding.html"><a href="visualizing-marker-genes-on-an-embedding.html"><i class="fa fa-check"></i><b>9.4</b> Visualizing Marker Genes on an Embedding</a></li>
<li class="chapter" data-level="9.5" data-path="marker-genes-imputation-with-magic.html"><a href="marker-genes-imputation-with-magic.html"><i class="fa fa-check"></i><b>9.5</b> Marker Genes Imputation with MAGIC</a></li>
<li class="chapter" data-level="9.6" data-path="module-scores.html"><a href="module-scores.html"><i class="fa fa-check"></i><b>9.6</b> Module Scores</a></li>
<li class="chapter" data-level="9.7" data-path="track-plotting-with-archrbrowser.html"><a href="track-plotting-with-archrbrowser.html"><i class="fa fa-check"></i><b>9.7</b> Track Plotting with ArchRBrowser</a></li>
<li class="chapter" data-level="9.8" data-path="launching-the-interactive-archrbrowser.html"><a href="launching-the-interactive-archrbrowser.html"><i class="fa fa-check"></i><b>9.8</b> Launching the Interactive ArchRBrowser</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="defining-cluster-identity-with-scrna-seq.html"><a href="defining-cluster-identity-with-scrna-seq.html"><i class="fa fa-check"></i><b>10</b> Defining Cluster Identity with scRNA-seq</a>
<ul>
<li class="chapter" data-level="10.1" data-path="cross-platform-linkage-of-scatac-seq-cells-with-scrna-seq-cells.html"><a href="cross-platform-linkage-of-scatac-seq-cells-with-scrna-seq-cells.html"><i class="fa fa-check"></i><b>10.1</b> Cross-platform linkage of scATAC-seq cells with scRNA-seq cells</a></li>
<li class="chapter" data-level="10.2" data-path="adding-pseudo-scrna-seq-profiles-for-each-scatac-seq-cell.html"><a href="adding-pseudo-scrna-seq-profiles-for-each-scatac-seq-cell.html"><i class="fa fa-check"></i><b>10.2</b> Adding Pseudo-scRNA-seq profiles for each scATAC-seq cell</a></li>
<li class="chapter" data-level="10.3" data-path="labeling-scatac-seq-clusters-with-scrna-seq-information.html"><a href="labeling-scatac-seq-clusters-with-scrna-seq-information.html"><i class="fa fa-check"></i><b>10.3</b> Labeling scATAC-seq clusters with scRNA-seq information</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="pseudo-bulk-replicates-in-archr.html"><a href="pseudo-bulk-replicates-in-archr.html"><i class="fa fa-check"></i><b>11</b> Pseudo-bulk Replicates in ArchR</a>
<ul>
<li class="chapter" data-level="11.1" data-path="how-does-archr-make-pseudo-bulk-replicates.html"><a href="how-does-archr-make-pseudo-bulk-replicates.html"><i class="fa fa-check"></i><b>11.1</b> How Does ArchR Make Pseudo-bulk Replicates?</a></li>
<li class="chapter" data-level="11.2" data-path="making-pseudo-bulk-replicates.html"><a href="making-pseudo-bulk-replicates.html"><i class="fa fa-check"></i><b>11.2</b> Making Pseudo-bulk Replicates</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="calling-peaks-with-archr.html"><a href="calling-peaks-with-archr.html"><i class="fa fa-check"></i><b>12</b> Calling Peaks with ArchR</a>
<ul>
<li class="chapter" data-level="12.1" data-path="the-iterative-overlap-peak-merging-procedure.html"><a href="the-iterative-overlap-peak-merging-procedure.html"><i class="fa fa-check"></i><b>12.1</b> The Iterative Overlap Peak Merging Procedure</a></li>
<li class="chapter" data-level="12.2" data-path="calling-peaks-w-macs2.html"><a href="calling-peaks-w-macs2.html"><i class="fa fa-check"></i><b>12.2</b> Calling Peaks w/ Macs2</a></li>
<li class="chapter" data-level="12.3" data-path="calling-peaks-w-tilematrix.html"><a href="calling-peaks-w-tilematrix.html"><i class="fa fa-check"></i><b>12.3</b> Calling Peaks w/ TileMatrix</a></li>
<li class="chapter" data-level="12.4" data-path="adding-a-peak-matrix.html"><a href="adding-a-peak-matrix.html"><i class="fa fa-check"></i><b>12.4</b> Adding a Peak Matrix</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="identifying-marker-peaks.html"><a href="identifying-marker-peaks.html"><i class="fa fa-check"></i><b>13</b> Identifying Marker Peaks</a>
<ul>
<li class="chapter" data-level="13.1" data-path="identifying-marker-peaks-with-archr.html"><a href="identifying-marker-peaks-with-archr.html"><i class="fa fa-check"></i><b>13.1</b> Identifying Marker Peaks with ArchR</a></li>
<li class="chapter" data-level="13.2" data-path="plotting-marker-peaks-in-archr.html"><a href="plotting-marker-peaks-in-archr.html"><i class="fa fa-check"></i><b>13.2</b> Plotting Marker Peaks in ArchR</a></li>
<li class="chapter" data-level="13.3" data-path="pairwise-testing-between-groups.html"><a href="pairwise-testing-between-groups.html"><i class="fa fa-check"></i><b>13.3</b> Pairwise Testing Between Groups</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="motif-and-feature-enrichment-with-archr.html"><a href="motif-and-feature-enrichment-with-archr.html"><i class="fa fa-check"></i><b>14</b> Motif and Feature Enrichment with ArchR</a>
<ul>
<li class="chapter" data-level="14.1" data-path="motif-enrichment.html"><a href="motif-enrichment.html"><i class="fa fa-check"></i><b>14.1</b> Motif Enrichment</a></li>
<li class="chapter" data-level="14.2" data-path="archr-enrichment.html"><a href="archr-enrichment.html"><i class="fa fa-check"></i><b>14.2</b> ArchR Enrichment</a></li>
<li class="chapter" data-level="14.3" data-path="custom-enrichment.html"><a href="custom-enrichment.html"><i class="fa fa-check"></i><b>14.3</b> Custom Enrichment</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="chromvar-deviatons-enrichment-with-archr.html"><a href="chromvar-deviatons-enrichment-with-archr.html"><i class="fa fa-check"></i><b>15</b> ChromVAR Deviatons Enrichment with ArchR</a>
<ul>
<li class="chapter" data-level="15.1" data-path="motif-deviations.html"><a href="motif-deviations.html"><i class="fa fa-check"></i><b>15.1</b> Motif Deviations</a></li>
<li class="chapter" data-level="15.2" data-path="archr-and-custom-deviations.html"><a href="archr-and-custom-deviations.html"><i class="fa fa-check"></i><b>15.2</b> ArchR and Custom Deviations</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="footprinting-with-archr.html"><a href="footprinting-with-archr.html"><i class="fa fa-check"></i><b>16</b> Footprinting with ArchR</a>
<ul>
<li class="chapter" data-level="16.1" data-path="motif-footprinting.html"><a href="motif-footprinting.html"><i class="fa fa-check"></i><b>16.1</b> Motif Footprinting</a></li>
<li class="chapter" data-level="16.2" data-path="normalization-of-footprints-for-tn5-bias.html"><a href="normalization-of-footprints-for-tn5-bias.html"><i class="fa fa-check"></i><b>16.2</b> Normalization of Footprints for Tn5 Bias</a></li>
<li class="chapter" data-level="16.3" data-path="feature-footprinting.html"><a href="feature-footprinting.html"><i class="fa fa-check"></i><b>16.3</b> Feature Footprinting</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="integrative-analysis-with-archr.html"><a href="integrative-analysis-with-archr.html"><i class="fa fa-check"></i><b>17</b> Integrative Analysis with ArchR</a>
<ul>
<li class="chapter" data-level="17.1" data-path="creating-low-overlapping-aggregates-of-cells.html"><a href="creating-low-overlapping-aggregates-of-cells.html"><i class="fa fa-check"></i><b>17.1</b> Creating Low-Overlapping Aggregates of Cells</a></li>
<li class="chapter" data-level="17.2" data-path="co-accessibility-with-archr.html"><a href="co-accessibility-with-archr.html"><i class="fa fa-check"></i><b>17.2</b> Co-accessibility with ArchR</a></li>
<li class="chapter" data-level="17.3" data-path="peak2genelinkage-with-archr.html"><a href="peak2genelinkage-with-archr.html"><i class="fa fa-check"></i><b>17.3</b> Peak2GeneLinkage with ArchR</a></li>
<li class="chapter" data-level="17.4" data-path="identification-of-positive-tf-regulators.html"><a href="identification-of-positive-tf-regulators.html"><i class="fa fa-check"></i><b>17.4</b> Identification of Positive TF-Regulators</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="trajectory-analysis-with-archr.html"><a href="trajectory-analysis-with-archr.html"><i class="fa fa-check"></i><b>18</b> Trajectory Analysis with ArchR</a>
<ul>
<li class="chapter" data-level="18.1" data-path="myeloid-trajectory---monocyte-differentiation.html"><a href="myeloid-trajectory---monocyte-differentiation.html"><i class="fa fa-check"></i><b>18.1</b> Myeloid Trajectory - Monocyte Differentiation</a></li>
<li class="chapter" data-level="18.2" data-path="lymphoid-trajectory---b-cell-differentiation.html"><a href="lymphoid-trajectory---b-cell-differentiation.html"><i class="fa fa-check"></i><b>18.2</b> Lymphoid Trajectory - B Cell Differentiation</a></li>
<li class="chapter" data-level="18.3" data-path="monocle3-trajectories.html"><a href="monocle3-trajectories.html"><i class="fa fa-check"></i><b>18.3</b> Monocle3 Trajectories</a></li>
<li class="chapter" data-level="18.4" data-path="slingshot-trajectories.html"><a href="slingshot-trajectories.html"><i class="fa fa-check"></i><b>18.4</b> Slingshot Trajectories</a></li>
<li class="chapter" data-level="18.5" data-path="comparing-the-different-trajectories.html"><a href="comparing-the-different-trajectories.html"><i class="fa fa-check"></i><b>18.5</b> Comparing the different trajectories</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="handling-archr-output.html"><a href="handling-archr-output.html"><i class="fa fa-check"></i><b>19</b> Handling ArchR Output</a>
<ul>
<li class="chapter" data-level="19.1" data-path="exporting-fragment-level-data.html"><a href="exporting-fragment-level-data.html"><i class="fa fa-check"></i><b>19.1</b> Exporting fragment-level data</a></li>
<li class="chapter" data-level="19.2" data-path="exporting-matrix-level-data.html"><a href="exporting-matrix-level-data.html"><i class="fa fa-check"></i><b>19.2</b> Exporting matrix-level data</a></li>
<li class="chapter" data-level="19.3" data-path="exporting-pseudo-bulked-data-to-a-summarizedexperiment.html"><a href="exporting-pseudo-bulked-data-to-a-summarizedexperiment.html"><i class="fa fa-check"></i><b>19.3</b> Exporting pseudo-bulked data to a <code>SummarizedExperiment</code></a></li>
<li class="chapter" data-level="19.4" data-path="exporting-pseudo-bulked-data-to-a-bigwig-file.html"><a href="exporting-pseudo-bulked-data-to-a-bigwig-file.html"><i class="fa fa-check"></i><b>19.4</b> Exporting pseudo-bulked data to a bigWig file</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="integration-with-bulk-atac-seq.html"><a href="integration-with-bulk-atac-seq.html"><i class="fa fa-check"></i><b>20</b> Integration with bulk ATAC-seq</a>
<ul>
<li class="chapter" data-level="20.1" data-path="projecting-bulk-atac-seq-data.html"><a href="projecting-bulk-atac-seq-data.html"><i class="fa fa-check"></i><b>20.1</b> Projecting bulk ATAC-seq data</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="multiomic-data-analysis-in-archr.html"><a href="multiomic-data-analysis-in-archr.html"><i class="fa fa-check"></i><b>21</b> Multiomic data analysis in ArchR</a>
<ul>
<li class="chapter" data-level="21.1" data-path="importing-data-and-setting-up-a-multiome-project.html"><a href="importing-data-and-setting-up-a-multiome-project.html"><i class="fa fa-check"></i><b>21.1</b> Importing data and setting up a Multiome project</a></li>
<li class="chapter" data-level="21.2" data-path="analysis-of-multiome-data-in-archr.html"><a href="analysis-of-multiome-data-in-archr.html"><i class="fa fa-check"></i><b>21.2</b> Analysis of multiome data in ArchR</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="plot-aesthetics-in-archr.html"><a href="plot-aesthetics-in-archr.html"><i class="fa fa-check"></i><b>22</b> Plot aesthetics in ArchR</a>
<ul>
<li class="chapter" data-level="22.1" data-path="using-and-manipulating-palettes-in-archr.html"><a href="using-and-manipulating-palettes-in-archr.html"><i class="fa fa-check"></i><b>22.1</b> Using and manipulating palettes in ArchR</a></li>
</ul></li>
<li class="chapter" data-level="23" data-path="testing-your-archr-installation.html"><a href="testing-your-archr-installation.html"><i class="fa fa-check"></i><b>23</b> Testing Your ArchR Installation</a></li>
<li class="chapter" data-level="24" data-path="session-information.html"><a href="session-information.html"><i class="fa fa-check"></i><b>24</b> Session Information</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="_blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">ArchR: Robust and scaleable analysis of single-cell chromatin accessibility data.</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="archr-and-custom-deviations" class="section level2 hasAnchor" number="15.2">
<h2><span class="header-section-number">15.2</span> ArchR and Custom Deviations<a href="archr-and-custom-deviations.html#archr-and-custom-deviations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the chapter on Peak Annotation Enrichment, we introduced how to create peak annotations for any set of genomic regions. This encluded (i) ArchR-supported region sets such as curated TF binding sites from ENCODE and peak sets from bulk ATAC-seq and (ii) custom user-supplied region sets. If you have not read this section, we recommend doing so to better understand how peak annotations work.</p>
<p>These peak annotations can be used in deviation calculations in the same way as motifs. Here we provide examples of how to run these analyses but note that the downstream analyses are identical to what was shown in the previous section for motifs and thus we do not provide extensive details on each step of the code. Once you create a deviations matrix in your Arrow files, the rest is the same.</p>
<div id="encode-tfbs" class="section level3 hasAnchor" number="15.2.1">
<h3><span class="header-section-number">15.2.1</span> Encode TFBS<a href="archr-and-custom-deviations.html#encode-tfbs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In case you have not added an annotations matrix for the “EncodeTFBS” region set, lets do that now.</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="archr-and-custom-deviations.html#cb300-1" tabindex="-1"></a><span class="cf">if</span>(<span class="st">&quot;EncodeTFBS&quot;</span> <span class="sc">%ni%</span> <span class="fu">names</span>(projHeme5<span class="sc">@</span>peakAnnotation)){</span>
<span id="cb300-2"><a href="archr-and-custom-deviations.html#cb300-2" tabindex="-1"></a>    projHeme5 <span class="ot">&lt;-</span> <span class="fu">addArchRAnnotations</span>(<span class="at">ArchRProj =</span> projHeme5, <span class="at">collection =</span> <span class="st">&quot;EncodeTFBS&quot;</span>)</span>
<span id="cb300-3"><a href="archr-and-custom-deviations.html#cb300-3" tabindex="-1"></a>}</span></code></pre></div>
<p>Then, we create a deviations matrix, providing this peak annotation to the <code>peakAnnotation</code> parameter.</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="archr-and-custom-deviations.html#cb301-1" tabindex="-1"></a>projHeme5 <span class="ot">&lt;-</span> <span class="fu">addDeviationsMatrix</span>(</span>
<span id="cb301-2"><a href="archr-and-custom-deviations.html#cb301-2" tabindex="-1"></a>  <span class="at">ArchRProj =</span> projHeme5, </span>
<span id="cb301-3"><a href="archr-and-custom-deviations.html#cb301-3" tabindex="-1"></a>  <span class="at">peakAnnotation =</span> <span class="st">&quot;EncodeTFBS&quot;</span>,</span>
<span id="cb301-4"><a href="archr-and-custom-deviations.html#cb301-4" tabindex="-1"></a>  <span class="at">force =</span> <span class="cn">TRUE</span></span>
<span id="cb301-5"><a href="archr-and-custom-deviations.html#cb301-5" tabindex="-1"></a>)</span>
<span id="cb301-6"><a href="archr-and-custom-deviations.html#cb301-6" tabindex="-1"></a><span class="do">## Using Previous Background Peaks!</span></span>
<span id="cb301-7"><a href="archr-and-custom-deviations.html#cb301-7" tabindex="-1"></a><span class="do">## ArchR logging to : ArchRLogs/ArchR-addDeviationsMatrix-92d4b5c23-Date-2025-02-06_Time-02-21-47.301582.log</span></span>
<span id="cb301-8"><a href="archr-and-custom-deviations.html#cb301-8" tabindex="-1"></a><span class="do">## If there is an issue, please report to github with logFile!</span></span>
<span id="cb301-9"><a href="archr-and-custom-deviations.html#cb301-9" tabindex="-1"></a><span class="do">## 2025-02-06 02:21:52.694577 : Batch Execution w/ safelapply!, 0 mins elapsed.</span></span>
<span id="cb301-10"><a href="archr-and-custom-deviations.html#cb301-10" tabindex="-1"></a><span class="do">## ###########</span></span>
<span id="cb301-11"><a href="archr-and-custom-deviations.html#cb301-11" tabindex="-1"></a><span class="do">## 2025-02-06 02:31:20.104834 : Completed Computing Deviations!, 9.547 mins elapsed.</span></span>
<span id="cb301-12"><a href="archr-and-custom-deviations.html#cb301-12" tabindex="-1"></a><span class="do">## ###########</span></span>
<span id="cb301-13"><a href="archr-and-custom-deviations.html#cb301-13" tabindex="-1"></a><span class="do">## ArchR logging successful to : ArchRLogs/ArchR-addDeviationsMatrix-92d4b5c23-Date-2025-02-06_Time-02-21-47.301582.log</span></span></code></pre></div>
<p>We can create a dot plot of the ranked deviations.</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="archr-and-custom-deviations.html#cb302-1" tabindex="-1"></a>plotVarDev <span class="ot">&lt;-</span> <span class="fu">getVarDeviations</span>(projHeme5, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">name =</span> <span class="st">&quot;EncodeTFBSMatrix&quot;</span>)</span>
<span id="cb302-2"><a href="archr-and-custom-deviations.html#cb302-2" tabindex="-1"></a><span class="do">## DataFrame with 6 rows and 6 columns</span></span>
<span id="cb302-3"><a href="archr-and-custom-deviations.html#cb302-3" tabindex="-1"></a><span class="do">##      seqnames       idx                   name combinedVars combinedMeans</span></span>
<span id="cb302-4"><a href="archr-and-custom-deviations.html#cb302-4" tabindex="-1"></a><span class="do">##         &lt;Rle&gt; &lt;integer&gt;            &lt;character&gt;    &lt;numeric&gt;     &lt;numeric&gt;</span></span>
<span id="cb302-5"><a href="archr-and-custom-deviations.html#cb302-5" tabindex="-1"></a><span class="do">## f222        z       222    222.GATA2_S-K562...      22.2115  -0.015532856</span></span>
<span id="cb302-6"><a href="archr-and-custom-deviations.html#cb302-6" tabindex="-1"></a><span class="do">## f542        z       542    542.TAL1_SC-K562...      19.4159   0.000522449</span></span>
<span id="cb302-7"><a href="archr-and-custom-deviations.html#cb302-7" tabindex="-1"></a><span class="do">## f498        z       498     498.GATA_2-K562...      16.5423  -0.012099706</span></span>
<span id="cb302-8"><a href="archr-and-custom-deviations.html#cb302-8" tabindex="-1"></a><span class="do">## f584        z       584 584.GATA_1-PBDEFetal..      15.3413   0.006277432</span></span>
<span id="cb302-9"><a href="archr-and-custom-deviations.html#cb302-9" tabindex="-1"></a><span class="do">## f497        z       497     497.GATA_1-K562...      12.9395   0.005494656</span></span>
<span id="cb302-10"><a href="archr-and-custom-deviations.html#cb302-10" tabindex="-1"></a><span class="do">## f591        z       591    591.eGFP_GA-K562...      12.7095  -0.004418393</span></span>
<span id="cb302-11"><a href="archr-and-custom-deviations.html#cb302-11" tabindex="-1"></a><span class="do">##           rank</span></span>
<span id="cb302-12"><a href="archr-and-custom-deviations.html#cb302-12" tabindex="-1"></a><span class="do">##      &lt;integer&gt;</span></span>
<span id="cb302-13"><a href="archr-and-custom-deviations.html#cb302-13" tabindex="-1"></a><span class="do">## f222         1</span></span>
<span id="cb302-14"><a href="archr-and-custom-deviations.html#cb302-14" tabindex="-1"></a><span class="do">## f542         2</span></span>
<span id="cb302-15"><a href="archr-and-custom-deviations.html#cb302-15" tabindex="-1"></a><span class="do">## f498         3</span></span>
<span id="cb302-16"><a href="archr-and-custom-deviations.html#cb302-16" tabindex="-1"></a><span class="do">## f584         4</span></span>
<span id="cb302-17"><a href="archr-and-custom-deviations.html#cb302-17" tabindex="-1"></a><span class="do">## f497         5</span></span>
<span id="cb302-18"><a href="archr-and-custom-deviations.html#cb302-18" tabindex="-1"></a><span class="do">## f591         6</span></span>
<span id="cb302-19"><a href="archr-and-custom-deviations.html#cb302-19" tabindex="-1"></a>plotVarDev</span>
<span id="cb302-20"><a href="archr-and-custom-deviations.html#cb302-20" tabindex="-1"></a><span class="do">## Warning: Removed 6 rows containing missing values or values outside the scale</span></span>
<span id="cb302-21"><a href="archr-and-custom-deviations.html#cb302-21" tabindex="-1"></a><span class="do">## range (`geom_point()`).</span></span>
<span id="cb302-22"><a href="archr-and-custom-deviations.html#cb302-22" tabindex="-1"></a><span class="do">## Warning: ggrepel: 15 unlabeled data points (too many overlaps). Consider</span></span>
<span id="cb302-23"><a href="archr-and-custom-deviations.html#cb302-23" tabindex="-1"></a><span class="do">## increasing max.overlaps</span></span></code></pre></div>
<p><img src="ArchR_files/figure-html/getVarDeviations2-1.svg" width="672" /></p>
<p>To save an editable vectorized version of this plot, we use the <code>plotPDF()</code> function.</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="archr-and-custom-deviations.html#cb303-1" tabindex="-1"></a><span class="fu">plotPDF</span>(plotVarDev, <span class="at">name =</span> <span class="st">&quot;Variable-EncodeTFBS-Deviation-Scores&quot;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">5</span>, <span class="at">ArchRProj =</span> projHeme5, <span class="at">addDOC =</span> <span class="cn">FALSE</span>)</span>
<span id="cb303-2"><a href="archr-and-custom-deviations.html#cb303-2" tabindex="-1"></a><span class="do">## Plotting Ggplot!</span></span></code></pre></div>
<p>Or we can subset these TF binding sites to particular motifs we are interested in and then plot their deviation z-scores per-cell on our UMAP embedding.</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="archr-and-custom-deviations.html#cb304-1" tabindex="-1"></a>tfs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;GATA_1&quot;</span>, <span class="st">&quot;CEBPB&quot;</span>, <span class="st">&quot;EBF1&quot;</span>, <span class="st">&quot;IRF4&quot;</span>, <span class="st">&quot;TBX21&quot;</span>, <span class="st">&quot;PAX5&quot;</span>)</span>
<span id="cb304-2"><a href="archr-and-custom-deviations.html#cb304-2" tabindex="-1"></a><span class="fu">getFeatures</span>(projHeme5, <span class="at">select =</span> <span class="fu">paste</span>(tfs, <span class="at">collapse=</span><span class="st">&quot;|&quot;</span>), <span class="at">useMatrix =</span> <span class="st">&quot;EncodeTFBSMatrix&quot;</span>)</span>
<span id="cb304-3"><a href="archr-and-custom-deviations.html#cb304-3" tabindex="-1"></a><span class="do">##  [1] &quot;z:584.GATA_1-PBDEFetal...&quot;          &quot;z:582.GATA_1-PBDE...&quot;              </span></span>
<span id="cb304-4"><a href="archr-and-custom-deviations.html#cb304-4" tabindex="-1"></a><span class="do">##  [3] &quot;z:497.GATA_1-K562...&quot;               &quot;z:477.CEBPB-K562...&quot;               </span></span>
<span id="cb304-5"><a href="archr-and-custom-deviations.html#cb304-5" tabindex="-1"></a><span class="do">##  [5] &quot;z:462.CEBPB-IMR90...&quot;               &quot;z:427.CEBPB-HepG2...&quot;              </span></span>
<span id="cb304-6"><a href="archr-and-custom-deviations.html#cb304-6" tabindex="-1"></a><span class="do">##  [7] &quot;z:426.CEBPB-HepG2...&quot;               &quot;z:379.CEBPB-HeLa_S3...&quot;            </span></span>
<span id="cb304-7"><a href="archr-and-custom-deviations.html#cb304-7" tabindex="-1"></a><span class="do">##  [9] &quot;z:344.CEBPB-H1_hESC...&quot;             &quot;z:293.EBF1_SC-GM12878...&quot;          </span></span>
<span id="cb304-8"><a href="archr-and-custom-deviations.html#cb304-8" tabindex="-1"></a><span class="do">## [11] &quot;z:278.CEBPB-A549...&quot;                &quot;z:213.CEBPB_S-K562...&quot;             </span></span>
<span id="cb304-9"><a href="archr-and-custom-deviations.html#cb304-9" tabindex="-1"></a><span class="do">## [13] &quot;z:173.CEBPB_S-HepG2...&quot;             &quot;z:130.PAX5_C2-GM12892...&quot;          </span></span>
<span id="cb304-10"><a href="archr-and-custom-deviations.html#cb304-10" tabindex="-1"></a><span class="do">## [15] &quot;z:123.PAX5_C2-GM12891...&quot;           &quot;z:102.PAX5_N1-GM12878...&quot;          </span></span>
<span id="cb304-11"><a href="archr-and-custom-deviations.html#cb304-11" tabindex="-1"></a><span class="do">## [17] &quot;z:101.PAX5_C2-GM12878...&quot;           &quot;z:93.IRF4_SC-GM12878...&quot;           </span></span>
<span id="cb304-12"><a href="archr-and-custom-deviations.html#cb304-12" tabindex="-1"></a><span class="do">## [19] &quot;z:87.EBF1_SC-GM12878...&quot;            &quot;z:86.CEBPB_S-GM12878...&quot;           </span></span>
<span id="cb304-13"><a href="archr-and-custom-deviations.html#cb304-13" tabindex="-1"></a><span class="do">## [21] &quot;deviations:584.GATA_1-PBDEFetal...&quot; &quot;deviations:582.GATA_1-PBDE...&quot;     </span></span>
<span id="cb304-14"><a href="archr-and-custom-deviations.html#cb304-14" tabindex="-1"></a><span class="do">## [23] &quot;deviations:497.GATA_1-K562...&quot;      &quot;deviations:477.CEBPB-K562...&quot;      </span></span>
<span id="cb304-15"><a href="archr-and-custom-deviations.html#cb304-15" tabindex="-1"></a><span class="do">## [25] &quot;deviations:462.CEBPB-IMR90...&quot;      &quot;deviations:427.CEBPB-HepG2...&quot;     </span></span>
<span id="cb304-16"><a href="archr-and-custom-deviations.html#cb304-16" tabindex="-1"></a><span class="do">## [27] &quot;deviations:426.CEBPB-HepG2...&quot;      &quot;deviations:379.CEBPB-HeLa_S3...&quot;   </span></span>
<span id="cb304-17"><a href="archr-and-custom-deviations.html#cb304-17" tabindex="-1"></a><span class="do">## [29] &quot;deviations:344.CEBPB-H1_hESC...&quot;    &quot;deviations:293.EBF1_SC-GM12878...&quot; </span></span>
<span id="cb304-18"><a href="archr-and-custom-deviations.html#cb304-18" tabindex="-1"></a><span class="do">## [31] &quot;deviations:278.CEBPB-A549...&quot;       &quot;deviations:213.CEBPB_S-K562...&quot;    </span></span>
<span id="cb304-19"><a href="archr-and-custom-deviations.html#cb304-19" tabindex="-1"></a><span class="do">## [33] &quot;deviations:173.CEBPB_S-HepG2...&quot;    &quot;deviations:130.PAX5_C2-GM12892...&quot; </span></span>
<span id="cb304-20"><a href="archr-and-custom-deviations.html#cb304-20" tabindex="-1"></a><span class="do">## [35] &quot;deviations:123.PAX5_C2-GM12891...&quot;  &quot;deviations:102.PAX5_N1-GM12878...&quot; </span></span>
<span id="cb304-21"><a href="archr-and-custom-deviations.html#cb304-21" tabindex="-1"></a><span class="do">## [37] &quot;deviations:101.PAX5_C2-GM12878...&quot;  &quot;deviations:93.IRF4_SC-GM12878...&quot;  </span></span>
<span id="cb304-22"><a href="archr-and-custom-deviations.html#cb304-22" tabindex="-1"></a><span class="do">## [39] &quot;deviations:87.EBF1_SC-GM12878...&quot;   &quot;deviations:86.CEBPB_S-GM12878...&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="archr-and-custom-deviations.html#cb305-1" tabindex="-1"></a>markerTFs <span class="ot">&lt;-</span> <span class="fu">getFeatures</span>(projHeme5, <span class="at">select =</span> <span class="fu">paste</span>(tfs, <span class="at">collapse=</span><span class="st">&quot;|&quot;</span>), <span class="at">useMatrix =</span> <span class="st">&quot;EncodeTFBSMatrix&quot;</span>)</span>
<span id="cb305-2"><a href="archr-and-custom-deviations.html#cb305-2" tabindex="-1"></a>markerTFs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">grep</span>(<span class="st">&quot;z:&quot;</span>, markerTFs, <span class="at">value =</span> <span class="cn">TRUE</span>))</span>
<span id="cb305-3"><a href="archr-and-custom-deviations.html#cb305-3" tabindex="-1"></a>TFnames <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_split</span>(stringr<span class="sc">::</span><span class="fu">str_split</span>(markerTFs, <span class="at">pattern =</span> <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.&quot;</span>, <span class="at">simplify=</span><span class="cn">TRUE</span>)[,<span class="dv">2</span>], <span class="at">pattern =</span> <span class="st">&quot;-&quot;</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[,<span class="dv">1</span>]</span>
<span id="cb305-4"><a href="archr-and-custom-deviations.html#cb305-4" tabindex="-1"></a>markerTFs <span class="ot">&lt;-</span> markerTFs[<span class="sc">!</span><span class="fu">duplicated</span>(TFnames)]</span>
<span id="cb305-5"><a href="archr-and-custom-deviations.html#cb305-5" tabindex="-1"></a>markerTFs</span>
<span id="cb305-6"><a href="archr-and-custom-deviations.html#cb305-6" tabindex="-1"></a><span class="do">## [1] &quot;z:101.PAX5_C2-GM12878...&quot; &quot;z:102.PAX5_N1-GM12878...&quot;</span></span>
<span id="cb305-7"><a href="archr-and-custom-deviations.html#cb305-7" tabindex="-1"></a><span class="do">## [3] &quot;z:173.CEBPB_S-HepG2...&quot;   &quot;z:278.CEBPB-A549...&quot;     </span></span>
<span id="cb305-8"><a href="archr-and-custom-deviations.html#cb305-8" tabindex="-1"></a><span class="do">## [5] &quot;z:293.EBF1_SC-GM12878...&quot; &quot;z:497.GATA_1-K562...&quot;    </span></span>
<span id="cb305-9"><a href="archr-and-custom-deviations.html#cb305-9" tabindex="-1"></a><span class="do">## [7] &quot;z:93.IRF4_SC-GM12878...&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="archr-and-custom-deviations.html#cb306-1" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">plotEmbedding</span>(</span>
<span id="cb306-2"><a href="archr-and-custom-deviations.html#cb306-2" tabindex="-1"></a>    <span class="at">ArchRProj =</span> projHeme5, </span>
<span id="cb306-3"><a href="archr-and-custom-deviations.html#cb306-3" tabindex="-1"></a>    <span class="at">colorBy =</span> <span class="st">&quot;EncodeTFBSMatrix&quot;</span>, </span>
<span id="cb306-4"><a href="archr-and-custom-deviations.html#cb306-4" tabindex="-1"></a>    <span class="at">name =</span> markerTFs, </span>
<span id="cb306-5"><a href="archr-and-custom-deviations.html#cb306-5" tabindex="-1"></a>    <span class="at">embedding =</span> <span class="st">&quot;UMAP&quot;</span>,</span>
<span id="cb306-6"><a href="archr-and-custom-deviations.html#cb306-6" tabindex="-1"></a>    <span class="at">imputeWeights =</span> <span class="fu">getImputeWeights</span>(projHeme5)</span>
<span id="cb306-7"><a href="archr-and-custom-deviations.html#cb306-7" tabindex="-1"></a>)</span>
<span id="cb306-8"><a href="archr-and-custom-deviations.html#cb306-8" tabindex="-1"></a><span class="do">## Getting ImputeWeights</span></span>
<span id="cb306-9"><a href="archr-and-custom-deviations.html#cb306-9" tabindex="-1"></a><span class="do">## No imputeWeights found, returning NULL</span></span>
<span id="cb306-10"><a href="archr-and-custom-deviations.html#cb306-10" tabindex="-1"></a><span class="do">## ArchR logging to : ArchRLogs/ArchR-plotEmbedding-9487b3971-Date-2025-02-06_Time-02-31-28.473973.log</span></span>
<span id="cb306-11"><a href="archr-and-custom-deviations.html#cb306-11" tabindex="-1"></a><span class="do">## If there is an issue, please report to github with logFile!</span></span>
<span id="cb306-12"><a href="archr-and-custom-deviations.html#cb306-12" tabindex="-1"></a><span class="do">## Getting UMAP Embedding</span></span>
<span id="cb306-13"><a href="archr-and-custom-deviations.html#cb306-13" tabindex="-1"></a><span class="do">## ColorBy = EncodeTFBSMatrix</span></span>
<span id="cb306-14"><a href="archr-and-custom-deviations.html#cb306-14" tabindex="-1"></a><span class="do">## Getting Matrix Values...</span></span>
<span id="cb306-15"><a href="archr-and-custom-deviations.html#cb306-15" tabindex="-1"></a><span class="do">## 2025-02-06 02:31:29.881668 :</span></span>
<span id="cb306-16"><a href="archr-and-custom-deviations.html#cb306-16" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb306-17"><a href="archr-and-custom-deviations.html#cb306-17" tabindex="-1"></a><span class="do">## Plotting Embedding</span></span>
<span id="cb306-18"><a href="archr-and-custom-deviations.html#cb306-18" tabindex="-1"></a><span class="do">## 1 2 3 4 5 6 7 </span></span>
<span id="cb306-19"><a href="archr-and-custom-deviations.html#cb306-19" tabindex="-1"></a><span class="do">## ArchR logging successful to : ArchRLogs/ArchR-plotEmbedding-9487b3971-Date-2025-02-06_Time-02-31-28.473973.log</span></span></code></pre></div>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="archr-and-custom-deviations.html#cb307-1" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(p, <span class="cf">function</span>(x){</span>
<span id="cb307-2"><a href="archr-and-custom-deviations.html#cb307-2" tabindex="-1"></a>    x <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">&quot;none&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span> </span>
<span id="cb307-3"><a href="archr-and-custom-deviations.html#cb307-3" tabindex="-1"></a>    <span class="fu">theme_ArchR</span>(<span class="at">baseSize =</span> <span class="fl">6.5</span>) <span class="sc">+</span></span>
<span id="cb307-4"><a href="archr-and-custom-deviations.html#cb307-4" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="st">&quot;cm&quot;</span>)) <span class="sc">+</span></span>
<span id="cb307-5"><a href="archr-and-custom-deviations.html#cb307-5" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb307-6"><a href="archr-and-custom-deviations.html#cb307-6" tabindex="-1"></a>        <span class="at">axis.text.x=</span><span class="fu">element_blank</span>(), </span>
<span id="cb307-7"><a href="archr-and-custom-deviations.html#cb307-7" tabindex="-1"></a>        <span class="at">axis.ticks.x=</span><span class="fu">element_blank</span>(), </span>
<span id="cb307-8"><a href="archr-and-custom-deviations.html#cb307-8" tabindex="-1"></a>        <span class="at">axis.text.y=</span><span class="fu">element_blank</span>(), </span>
<span id="cb307-9"><a href="archr-and-custom-deviations.html#cb307-9" tabindex="-1"></a>        <span class="at">axis.ticks.y=</span><span class="fu">element_blank</span>()</span>
<span id="cb307-10"><a href="archr-and-custom-deviations.html#cb307-10" tabindex="-1"></a>    )</span>
<span id="cb307-11"><a href="archr-and-custom-deviations.html#cb307-11" tabindex="-1"></a>})</span>
<span id="cb307-12"><a href="archr-and-custom-deviations.html#cb307-12" tabindex="-1"></a><span class="fu">do.call</span>(cowplot<span class="sc">::</span>plot_grid, <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">ncol =</span> <span class="dv">3</span>),p2))</span></code></pre></div>
<p><img src="ArchR_files/figure-html/unnamed-chunk-296-1.svg" width="672" /></p>
</div>
<div id="bulk-atac-seq-1" class="section level3 hasAnchor" number="15.2.2">
<h3><span class="header-section-number">15.2.2</span> Bulk ATAC-seq<a href="archr-and-custom-deviations.html#bulk-atac-seq-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Similarly, we can use ArchR-curated bulk ATAC-seq peak sets for our motif deviation calculations.If you have not added motif annotations</p>
<p>In case you have not added an annotations matrix for the “EncodeTFBS” region set, lets do that now.</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="archr-and-custom-deviations.html#cb308-1" tabindex="-1"></a><span class="cf">if</span>(<span class="st">&quot;ATAC&quot;</span> <span class="sc">%ni%</span> <span class="fu">names</span>(projHeme5<span class="sc">@</span>peakAnnotation)){</span>
<span id="cb308-2"><a href="archr-and-custom-deviations.html#cb308-2" tabindex="-1"></a>    projHeme5 <span class="ot">&lt;-</span> <span class="fu">addArchRAnnotations</span>(<span class="at">ArchRProj =</span> projHeme5, <span class="at">collection =</span> <span class="st">&quot;ATAC&quot;</span>)</span>
<span id="cb308-3"><a href="archr-and-custom-deviations.html#cb308-3" tabindex="-1"></a>}</span></code></pre></div>
<p>Then, we create a deviations matrix, providing this peak annotation to the <code>peakAnnotation</code> parameter.</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="archr-and-custom-deviations.html#cb309-1" tabindex="-1"></a>projHeme5 <span class="ot">&lt;-</span> <span class="fu">addDeviationsMatrix</span>(</span>
<span id="cb309-2"><a href="archr-and-custom-deviations.html#cb309-2" tabindex="-1"></a>  <span class="at">ArchRProj =</span> projHeme5, </span>
<span id="cb309-3"><a href="archr-and-custom-deviations.html#cb309-3" tabindex="-1"></a>  <span class="at">peakAnnotation =</span> <span class="st">&quot;ATAC&quot;</span>,</span>
<span id="cb309-4"><a href="archr-and-custom-deviations.html#cb309-4" tabindex="-1"></a>  <span class="at">force =</span> <span class="cn">TRUE</span></span>
<span id="cb309-5"><a href="archr-and-custom-deviations.html#cb309-5" tabindex="-1"></a>)</span>
<span id="cb309-6"><a href="archr-and-custom-deviations.html#cb309-6" tabindex="-1"></a><span class="do">## Using Previous Background Peaks!</span></span>
<span id="cb309-7"><a href="archr-and-custom-deviations.html#cb309-7" tabindex="-1"></a><span class="do">## ArchR logging to : ArchRLogs/ArchR-addDeviationsMatrix-9598edbd3-Date-2025-02-06_Time-02-31-39.996216.log</span></span>
<span id="cb309-8"><a href="archr-and-custom-deviations.html#cb309-8" tabindex="-1"></a><span class="do">## If there is an issue, please report to github with logFile!</span></span>
<span id="cb309-9"><a href="archr-and-custom-deviations.html#cb309-9" tabindex="-1"></a><span class="do">## 2025-02-06 02:31:44.928769 : Batch Execution w/ safelapply!, 0 mins elapsed.</span></span>
<span id="cb309-10"><a href="archr-and-custom-deviations.html#cb309-10" tabindex="-1"></a><span class="do">## ###########</span></span>
<span id="cb309-11"><a href="archr-and-custom-deviations.html#cb309-11" tabindex="-1"></a><span class="do">## 2025-02-06 02:37:09.143985 : Completed Computing Deviations!, 5.486 mins elapsed.</span></span>
<span id="cb309-12"><a href="archr-and-custom-deviations.html#cb309-12" tabindex="-1"></a><span class="do">## ###########</span></span>
<span id="cb309-13"><a href="archr-and-custom-deviations.html#cb309-13" tabindex="-1"></a><span class="do">## ArchR logging successful to : ArchRLogs/ArchR-addDeviationsMatrix-9598edbd3-Date-2025-02-06_Time-02-31-39.996216.log</span></span></code></pre></div>
<p>We can create a dot plot of the ranked deviations.</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="archr-and-custom-deviations.html#cb310-1" tabindex="-1"></a>plotVarDev <span class="ot">&lt;-</span> <span class="fu">getVarDeviations</span>(projHeme5, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">name =</span> <span class="st">&quot;ATACMatrix&quot;</span>)</span>
<span id="cb310-2"><a href="archr-and-custom-deviations.html#cb310-2" tabindex="-1"></a><span class="do">## DataFrame with 6 rows and 6 columns</span></span>
<span id="cb310-3"><a href="archr-and-custom-deviations.html#cb310-3" tabindex="-1"></a><span class="do">##     seqnames       idx                   name combinedVars combinedMeans</span></span>
<span id="cb310-4"><a href="archr-and-custom-deviations.html#cb310-4" tabindex="-1"></a><span class="do">##        &lt;Rle&gt; &lt;integer&gt;            &lt;character&gt;    &lt;numeric&gt;     &lt;numeric&gt;</span></span>
<span id="cb310-5"><a href="archr-and-custom-deviations.html#cb310-5" tabindex="-1"></a><span class="do">## f22        z        22  IAtlas_T_CD8posCenMem      15.0345     -0.182932</span></span>
<span id="cb310-6"><a href="archr-and-custom-deviations.html#cb310-6" tabindex="-1"></a><span class="do">## f24        z        24  IAtlas_T_FollicHelper      14.6922     -0.152309</span></span>
<span id="cb310-7"><a href="archr-and-custom-deviations.html#cb310-7" tabindex="-1"></a><span class="do">## f21        z        21        IAtlas_T_CD8pos      14.5186     -0.173237</span></span>
<span id="cb310-8"><a href="archr-and-custom-deviations.html#cb310-8" tabindex="-1"></a><span class="do">## f19        z        19 IAtlas_T_CD4posEffec..      14.4562     -0.158722</span></span>
<span id="cb310-9"><a href="archr-and-custom-deviations.html#cb310-9" tabindex="-1"></a><span class="do">## f26        z        26    IAtlas_T_MemoryTeff      14.3618     -0.166626</span></span>
<span id="cb310-10"><a href="archr-and-custom-deviations.html#cb310-10" tabindex="-1"></a><span class="do">## f33        z        33  IAtlas_T_Th1Precursor      14.2731     -0.168414</span></span>
<span id="cb310-11"><a href="archr-and-custom-deviations.html#cb310-11" tabindex="-1"></a><span class="do">##          rank</span></span>
<span id="cb310-12"><a href="archr-and-custom-deviations.html#cb310-12" tabindex="-1"></a><span class="do">##     &lt;integer&gt;</span></span>
<span id="cb310-13"><a href="archr-and-custom-deviations.html#cb310-13" tabindex="-1"></a><span class="do">## f22         1</span></span>
<span id="cb310-14"><a href="archr-and-custom-deviations.html#cb310-14" tabindex="-1"></a><span class="do">## f24         2</span></span>
<span id="cb310-15"><a href="archr-and-custom-deviations.html#cb310-15" tabindex="-1"></a><span class="do">## f21         3</span></span>
<span id="cb310-16"><a href="archr-and-custom-deviations.html#cb310-16" tabindex="-1"></a><span class="do">## f19         4</span></span>
<span id="cb310-17"><a href="archr-and-custom-deviations.html#cb310-17" tabindex="-1"></a><span class="do">## f26         5</span></span>
<span id="cb310-18"><a href="archr-and-custom-deviations.html#cb310-18" tabindex="-1"></a><span class="do">## f33         6</span></span>
<span id="cb310-19"><a href="archr-and-custom-deviations.html#cb310-19" tabindex="-1"></a>plotVarDev</span>
<span id="cb310-20"><a href="archr-and-custom-deviations.html#cb310-20" tabindex="-1"></a><span class="do">## Warning: ggrepel: 17 unlabeled data points (too many overlaps). Consider</span></span>
<span id="cb310-21"><a href="archr-and-custom-deviations.html#cb310-21" tabindex="-1"></a><span class="do">## increasing max.overlaps</span></span></code></pre></div>
<p><img src="ArchR_files/figure-html/getVarDeviations3-1.svg" width="672" /></p>
<p>To save an editable vectorized version of this plot, we use the <code>plotPDF()</code> function.</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="archr-and-custom-deviations.html#cb311-1" tabindex="-1"></a><span class="fu">plotPDF</span>(plotVarDev, <span class="at">name =</span> <span class="st">&quot;Variable-ATAC-Deviation-Scores&quot;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">5</span>, <span class="at">ArchRProj =</span> projHeme5, <span class="at">addDOC =</span> <span class="cn">FALSE</span>)</span>
<span id="cb311-2"><a href="archr-and-custom-deviations.html#cb311-2" tabindex="-1"></a><span class="do">## Plotting Ggplot!</span></span></code></pre></div>
<p>Or we can plot the deviation z-scores for each of these peak sets per-cell on our UMAP embedding.</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="archr-and-custom-deviations.html#cb312-1" tabindex="-1"></a>ATACPeaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Heme_HSC&quot;</span>, <span class="st">&quot;Heme_LMPP&quot;</span>, <span class="st">&quot;Heme_Ery&quot;</span>, <span class="st">&quot;Heme_Mono&quot;</span>, <span class="st">&quot;Heme_CD4&quot;</span>, <span class="st">&quot;Heme_CD8&quot;</span>, <span class="st">&quot;Heme_B&quot;</span>, <span class="st">&quot;Heme_NK&quot;</span>, <span class="st">&quot;IAtlas_DC_Plasmacytoid&quot;</span>)</span>
<span id="cb312-2"><a href="archr-and-custom-deviations.html#cb312-2" tabindex="-1"></a>markerATAC <span class="ot">&lt;-</span> <span class="fu">getFeatures</span>(projHeme5, <span class="at">select =</span> <span class="fu">paste</span>(ATACPeaks, <span class="at">collapse=</span><span class="st">&quot;|&quot;</span>), <span class="at">useMatrix =</span> <span class="st">&quot;ATACMatrix&quot;</span>)</span>
<span id="cb312-3"><a href="archr-and-custom-deviations.html#cb312-3" tabindex="-1"></a>markerATAC <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">grep</span>(<span class="st">&quot;z:&quot;</span>, markerATAC, <span class="at">value =</span> <span class="cn">TRUE</span>))</span>
<span id="cb312-4"><a href="archr-and-custom-deviations.html#cb312-4" tabindex="-1"></a>markerATAC</span>
<span id="cb312-5"><a href="archr-and-custom-deviations.html#cb312-5" tabindex="-1"></a><span class="do">## [1] &quot;z:Heme_B&quot;                 &quot;z:Heme_CD4&quot;              </span></span>
<span id="cb312-6"><a href="archr-and-custom-deviations.html#cb312-6" tabindex="-1"></a><span class="do">## [3] &quot;z:Heme_CD8&quot;               &quot;z:Heme_Ery&quot;              </span></span>
<span id="cb312-7"><a href="archr-and-custom-deviations.html#cb312-7" tabindex="-1"></a><span class="do">## [5] &quot;z:Heme_HSC&quot;               &quot;z:Heme_LMPP&quot;             </span></span>
<span id="cb312-8"><a href="archr-and-custom-deviations.html#cb312-8" tabindex="-1"></a><span class="do">## [7] &quot;z:Heme_Mono&quot;              &quot;z:Heme_NK&quot;               </span></span>
<span id="cb312-9"><a href="archr-and-custom-deviations.html#cb312-9" tabindex="-1"></a><span class="do">## [9] &quot;z:IAtlas_DC_Plasmacytoid&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="archr-and-custom-deviations.html#cb313-1" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">plotEmbedding</span>(</span>
<span id="cb313-2"><a href="archr-and-custom-deviations.html#cb313-2" tabindex="-1"></a>    <span class="at">ArchRProj =</span> projHeme5, </span>
<span id="cb313-3"><a href="archr-and-custom-deviations.html#cb313-3" tabindex="-1"></a>    <span class="at">colorBy =</span> <span class="st">&quot;ATACMatrix&quot;</span>, </span>
<span id="cb313-4"><a href="archr-and-custom-deviations.html#cb313-4" tabindex="-1"></a>    <span class="at">name =</span> markerATAC, </span>
<span id="cb313-5"><a href="archr-and-custom-deviations.html#cb313-5" tabindex="-1"></a>    <span class="at">embedding =</span> <span class="st">&quot;UMAP&quot;</span>,</span>
<span id="cb313-6"><a href="archr-and-custom-deviations.html#cb313-6" tabindex="-1"></a>    <span class="at">imputeWeights =</span> <span class="fu">getImputeWeights</span>(projHeme5)</span>
<span id="cb313-7"><a href="archr-and-custom-deviations.html#cb313-7" tabindex="-1"></a>)</span>
<span id="cb313-8"><a href="archr-and-custom-deviations.html#cb313-8" tabindex="-1"></a><span class="do">## Getting ImputeWeights</span></span>
<span id="cb313-9"><a href="archr-and-custom-deviations.html#cb313-9" tabindex="-1"></a><span class="do">## No imputeWeights found, returning NULL</span></span>
<span id="cb313-10"><a href="archr-and-custom-deviations.html#cb313-10" tabindex="-1"></a><span class="do">## ArchR logging to : ArchRLogs/ArchR-plotEmbedding-975cf5d51-Date-2025-02-06_Time-02-37-16.995515.log</span></span>
<span id="cb313-11"><a href="archr-and-custom-deviations.html#cb313-11" tabindex="-1"></a><span class="do">## If there is an issue, please report to github with logFile!</span></span>
<span id="cb313-12"><a href="archr-and-custom-deviations.html#cb313-12" tabindex="-1"></a><span class="do">## Getting UMAP Embedding</span></span>
<span id="cb313-13"><a href="archr-and-custom-deviations.html#cb313-13" tabindex="-1"></a><span class="do">## ColorBy = ATACMatrix</span></span>
<span id="cb313-14"><a href="archr-and-custom-deviations.html#cb313-14" tabindex="-1"></a><span class="do">## Getting Matrix Values...</span></span>
<span id="cb313-15"><a href="archr-and-custom-deviations.html#cb313-15" tabindex="-1"></a><span class="do">## 2025-02-06 02:37:18.387709 :</span></span>
<span id="cb313-16"><a href="archr-and-custom-deviations.html#cb313-16" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb313-17"><a href="archr-and-custom-deviations.html#cb313-17" tabindex="-1"></a><span class="do">## Plotting Embedding</span></span>
<span id="cb313-18"><a href="archr-and-custom-deviations.html#cb313-18" tabindex="-1"></a><span class="do">## 1 2 3 4 5 6 7 8 9 </span></span>
<span id="cb313-19"><a href="archr-and-custom-deviations.html#cb313-19" tabindex="-1"></a><span class="do">## ArchR logging successful to : ArchRLogs/ArchR-plotEmbedding-975cf5d51-Date-2025-02-06_Time-02-37-16.995515.log</span></span></code></pre></div>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="archr-and-custom-deviations.html#cb314-1" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(p, <span class="cf">function</span>(x){</span>
<span id="cb314-2"><a href="archr-and-custom-deviations.html#cb314-2" tabindex="-1"></a>    x <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">&quot;none&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span> </span>
<span id="cb314-3"><a href="archr-and-custom-deviations.html#cb314-3" tabindex="-1"></a>    <span class="fu">theme_ArchR</span>(<span class="at">baseSize =</span> <span class="fl">6.5</span>) <span class="sc">+</span></span>
<span id="cb314-4"><a href="archr-and-custom-deviations.html#cb314-4" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="st">&quot;cm&quot;</span>)) <span class="sc">+</span></span>
<span id="cb314-5"><a href="archr-and-custom-deviations.html#cb314-5" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb314-6"><a href="archr-and-custom-deviations.html#cb314-6" tabindex="-1"></a>        <span class="at">axis.text.x=</span><span class="fu">element_blank</span>(), </span>
<span id="cb314-7"><a href="archr-and-custom-deviations.html#cb314-7" tabindex="-1"></a>        <span class="at">axis.ticks.x=</span><span class="fu">element_blank</span>(), </span>
<span id="cb314-8"><a href="archr-and-custom-deviations.html#cb314-8" tabindex="-1"></a>        <span class="at">axis.text.y=</span><span class="fu">element_blank</span>(), </span>
<span id="cb314-9"><a href="archr-and-custom-deviations.html#cb314-9" tabindex="-1"></a>        <span class="at">axis.ticks.y=</span><span class="fu">element_blank</span>()</span>
<span id="cb314-10"><a href="archr-and-custom-deviations.html#cb314-10" tabindex="-1"></a>    )</span>
<span id="cb314-11"><a href="archr-and-custom-deviations.html#cb314-11" tabindex="-1"></a>})</span>
<span id="cb314-12"><a href="archr-and-custom-deviations.html#cb314-12" tabindex="-1"></a><span class="fu">do.call</span>(cowplot<span class="sc">::</span>plot_grid, <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">ncol =</span> <span class="dv">3</span>),p2))</span></code></pre></div>
<p><img src="ArchR_files/figure-html/unnamed-chunk-301-1.svg" width="672" /></p>
</div>
<div id="custom-deviations" class="section level3 hasAnchor" number="15.2.3">
<h3><span class="header-section-number">15.2.3</span> Custom Deviations<a href="archr-and-custom-deviations.html#custom-deviations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Instead of using the ArchR-curated region sets described above, we can provide our own custom region sets as a peak annotation. These custom annotations can be used in exactly the same way as the ArchR-curated annotations.</p>
<p>First, in case you haven’t already created this “EncodePeaks” annotation in a previous chapter, lets create it by downloading some ENCODE peak sets and calling <code>addPeakAnnotations()</code>.</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="archr-and-custom-deviations.html#cb315-1" tabindex="-1"></a>EncodePeaks <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb315-2"><a href="archr-and-custom-deviations.html#cb315-2" tabindex="-1"></a>  <span class="at">Encode_K562_GATA1 =</span> <span class="st">&quot;https://www.encodeproject.org/files/ENCFF632NQI/@@download/ENCFF632NQI.bed.gz&quot;</span>,</span>
<span id="cb315-3"><a href="archr-and-custom-deviations.html#cb315-3" tabindex="-1"></a>  <span class="at">Encode_GM12878_CEBPB =</span> <span class="st">&quot;https://www.encodeproject.org/files/ENCFF761MGJ/@@download/ENCFF761MGJ.bed.gz&quot;</span>,</span>
<span id="cb315-4"><a href="archr-and-custom-deviations.html#cb315-4" tabindex="-1"></a>  <span class="at">Encode_K562_Ebf1 =</span> <span class="st">&quot;https://www.encodeproject.org/files/ENCFF868VSY/@@download/ENCFF868VSY.bed.gz&quot;</span>,</span>
<span id="cb315-5"><a href="archr-and-custom-deviations.html#cb315-5" tabindex="-1"></a>  <span class="at">Encode_K562_Pax5 =</span> <span class="st">&quot;https://www.encodeproject.org/files/ENCFF339KUO/@@download/ENCFF339KUO.bed.gz&quot;</span></span>
<span id="cb315-6"><a href="archr-and-custom-deviations.html#cb315-6" tabindex="-1"></a>)</span>
<span id="cb315-7"><a href="archr-and-custom-deviations.html#cb315-7" tabindex="-1"></a><span class="cf">if</span>(<span class="st">&quot;ChIP&quot;</span> <span class="sc">%ni%</span> <span class="fu">names</span>(projHeme5<span class="sc">@</span>peakAnnotation)){</span>
<span id="cb315-8"><a href="archr-and-custom-deviations.html#cb315-8" tabindex="-1"></a>    projHeme5 <span class="ot">&lt;-</span> <span class="fu">addPeakAnnotations</span>(<span class="at">ArchRProj =</span> projHeme5, <span class="at">regions =</span> EncodePeaks, <span class="at">name =</span> <span class="st">&quot;ChIP&quot;</span>)</span>
<span id="cb315-9"><a href="archr-and-custom-deviations.html#cb315-9" tabindex="-1"></a>}</span></code></pre></div>
<p>Then, we make a deviations matrix from this peak annotation.</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="archr-and-custom-deviations.html#cb316-1" tabindex="-1"></a>projHeme5 <span class="ot">&lt;-</span> <span class="fu">addDeviationsMatrix</span>(</span>
<span id="cb316-2"><a href="archr-and-custom-deviations.html#cb316-2" tabindex="-1"></a>  <span class="at">ArchRProj =</span> projHeme5, </span>
<span id="cb316-3"><a href="archr-and-custom-deviations.html#cb316-3" tabindex="-1"></a>  <span class="at">peakAnnotation =</span> <span class="st">&quot;ChIP&quot;</span>,</span>
<span id="cb316-4"><a href="archr-and-custom-deviations.html#cb316-4" tabindex="-1"></a>  <span class="at">force =</span> <span class="cn">TRUE</span></span>
<span id="cb316-5"><a href="archr-and-custom-deviations.html#cb316-5" tabindex="-1"></a>)</span>
<span id="cb316-6"><a href="archr-and-custom-deviations.html#cb316-6" tabindex="-1"></a><span class="do">## Using Previous Background Peaks!</span></span>
<span id="cb316-7"><a href="archr-and-custom-deviations.html#cb316-7" tabindex="-1"></a><span class="do">## ArchR logging to : ArchRLogs/ArchR-addDeviationsMatrix-913bca476-Date-2025-02-06_Time-02-37-27.670093.log</span></span>
<span id="cb316-8"><a href="archr-and-custom-deviations.html#cb316-8" tabindex="-1"></a><span class="do">## If there is an issue, please report to github with logFile!</span></span>
<span id="cb316-9"><a href="archr-and-custom-deviations.html#cb316-9" tabindex="-1"></a><span class="do">## 2025-02-06 02:37:34.307498 : Batch Execution w/ safelapply!, 0 mins elapsed.</span></span>
<span id="cb316-10"><a href="archr-and-custom-deviations.html#cb316-10" tabindex="-1"></a><span class="do">## ###########</span></span>
<span id="cb316-11"><a href="archr-and-custom-deviations.html#cb316-11" tabindex="-1"></a><span class="do">## 2025-02-06 02:37:56.862068 : Completed Computing Deviations!, 0.487 mins elapsed.</span></span>
<span id="cb316-12"><a href="archr-and-custom-deviations.html#cb316-12" tabindex="-1"></a><span class="do">## ###########</span></span>
<span id="cb316-13"><a href="archr-and-custom-deviations.html#cb316-13" tabindex="-1"></a><span class="do">## ArchR logging successful to : ArchRLogs/ArchR-addDeviationsMatrix-913bca476-Date-2025-02-06_Time-02-37-27.670093.log</span></span></code></pre></div>
<p>The rest of the analysis workflow is the same as what has now been presented multiple times above.</p>
<p>We can plot the ranked deviations.</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="archr-and-custom-deviations.html#cb317-1" tabindex="-1"></a>plotVarDev <span class="ot">&lt;-</span> <span class="fu">getVarDeviations</span>(projHeme5, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">name =</span> <span class="st">&quot;ChIPMatrix&quot;</span>)</span>
<span id="cb317-2"><a href="archr-and-custom-deviations.html#cb317-2" tabindex="-1"></a><span class="do">## DataFrame with 4 rows and 6 columns</span></span>
<span id="cb317-3"><a href="archr-and-custom-deviations.html#cb317-3" tabindex="-1"></a><span class="do">##    seqnames       idx                 name combinedVars combinedMeans      rank</span></span>
<span id="cb317-4"><a href="archr-and-custom-deviations.html#cb317-4" tabindex="-1"></a><span class="do">##       &lt;Rle&gt; &lt;integer&gt;          &lt;character&gt;    &lt;numeric&gt;     &lt;numeric&gt; &lt;integer&gt;</span></span>
<span id="cb317-5"><a href="archr-and-custom-deviations.html#cb317-5" tabindex="-1"></a><span class="do">## f1        z         1    Encode_K562_GATA1     11.81450   -0.00284038         1</span></span>
<span id="cb317-6"><a href="archr-and-custom-deviations.html#cb317-6" tabindex="-1"></a><span class="do">## f3        z         3     Encode_K562_Ebf1      4.87639    0.04424422         2</span></span>
<span id="cb317-7"><a href="archr-and-custom-deviations.html#cb317-7" tabindex="-1"></a><span class="do">## f4        z         4     Encode_K562_Pax5      2.76798   -0.01397631         3</span></span>
<span id="cb317-8"><a href="archr-and-custom-deviations.html#cb317-8" tabindex="-1"></a><span class="do">## f2        z         2 Encode_GM12878_CEBPB      1.38978   -0.00600790         4</span></span>
<span id="cb317-9"><a href="archr-and-custom-deviations.html#cb317-9" tabindex="-1"></a>plotVarDev</span>
<span id="cb317-10"><a href="archr-and-custom-deviations.html#cb317-10" tabindex="-1"></a><span class="do">## Warning: Removed 21 rows containing missing values or values outside the scale</span></span>
<span id="cb317-11"><a href="archr-and-custom-deviations.html#cb317-11" tabindex="-1"></a><span class="do">## range (`geom_label_repel()`).</span></span></code></pre></div>
<p><img src="ArchR_files/figure-html/getVarDeviations4-1.svg" width="672" /></p>
<p>To save an editable vectorized version of this plot, we use the <code>plotPDF()</code> function.</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="archr-and-custom-deviations.html#cb318-1" tabindex="-1"></a><span class="fu">plotPDF</span>(plotVarDev, <span class="at">name =</span> <span class="st">&quot;Variable-ChIP-Deviation-Scores&quot;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">5</span>, <span class="at">ArchRProj =</span> projHeme5, <span class="at">addDOC =</span> <span class="cn">FALSE</span>)</span>
<span id="cb318-2"><a href="archr-and-custom-deviations.html#cb318-2" tabindex="-1"></a><span class="do">## Plotting Ggplot!</span></span></code></pre></div>
<p>And we can plot the deviation z-scores overlayed on our UMAP embedding.</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb319-1"><a href="archr-and-custom-deviations.html#cb319-1" tabindex="-1"></a>markerChIP <span class="ot">&lt;-</span> <span class="fu">getFeatures</span>(projHeme5, <span class="at">useMatrix =</span> <span class="st">&quot;ChIPMatrix&quot;</span>)</span>
<span id="cb319-2"><a href="archr-and-custom-deviations.html#cb319-2" tabindex="-1"></a>markerChIP <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">grep</span>(<span class="st">&quot;z:&quot;</span>, markerChIP, <span class="at">value =</span> <span class="cn">TRUE</span>))</span>
<span id="cb319-3"><a href="archr-and-custom-deviations.html#cb319-3" tabindex="-1"></a>markerChIP</span>
<span id="cb319-4"><a href="archr-and-custom-deviations.html#cb319-4" tabindex="-1"></a><span class="do">## [1] &quot;z:Encode_GM12878_CEBPB&quot; &quot;z:Encode_K562_Ebf1&quot;     &quot;z:Encode_K562_GATA1&quot;   </span></span>
<span id="cb319-5"><a href="archr-and-custom-deviations.html#cb319-5" tabindex="-1"></a><span class="do">## [4] &quot;z:Encode_K562_Pax5&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="archr-and-custom-deviations.html#cb320-1" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">plotEmbedding</span>(</span>
<span id="cb320-2"><a href="archr-and-custom-deviations.html#cb320-2" tabindex="-1"></a>    <span class="at">ArchRProj =</span> projHeme5, </span>
<span id="cb320-3"><a href="archr-and-custom-deviations.html#cb320-3" tabindex="-1"></a>    <span class="at">colorBy =</span> <span class="st">&quot;ChIPMatrix&quot;</span>, </span>
<span id="cb320-4"><a href="archr-and-custom-deviations.html#cb320-4" tabindex="-1"></a>    <span class="at">name =</span> markerChIP, </span>
<span id="cb320-5"><a href="archr-and-custom-deviations.html#cb320-5" tabindex="-1"></a>    <span class="at">embedding =</span> <span class="st">&quot;UMAP&quot;</span>,</span>
<span id="cb320-6"><a href="archr-and-custom-deviations.html#cb320-6" tabindex="-1"></a>    <span class="at">imputeWeights =</span> <span class="fu">getImputeWeights</span>(projHeme5)</span>
<span id="cb320-7"><a href="archr-and-custom-deviations.html#cb320-7" tabindex="-1"></a>)</span>
<span id="cb320-8"><a href="archr-and-custom-deviations.html#cb320-8" tabindex="-1"></a><span class="do">## Getting ImputeWeights</span></span>
<span id="cb320-9"><a href="archr-and-custom-deviations.html#cb320-9" tabindex="-1"></a><span class="do">## No imputeWeights found, returning NULL</span></span>
<span id="cb320-10"><a href="archr-and-custom-deviations.html#cb320-10" tabindex="-1"></a><span class="do">## ArchR logging to : ArchRLogs/ArchR-plotEmbedding-9a35a137-Date-2025-02-06_Time-02-38-04.777479.log</span></span>
<span id="cb320-11"><a href="archr-and-custom-deviations.html#cb320-11" tabindex="-1"></a><span class="do">## If there is an issue, please report to github with logFile!</span></span>
<span id="cb320-12"><a href="archr-and-custom-deviations.html#cb320-12" tabindex="-1"></a><span class="do">## Getting UMAP Embedding</span></span>
<span id="cb320-13"><a href="archr-and-custom-deviations.html#cb320-13" tabindex="-1"></a><span class="do">## ColorBy = ChIPMatrix</span></span>
<span id="cb320-14"><a href="archr-and-custom-deviations.html#cb320-14" tabindex="-1"></a><span class="do">## Getting Matrix Values...</span></span>
<span id="cb320-15"><a href="archr-and-custom-deviations.html#cb320-15" tabindex="-1"></a><span class="do">## 2025-02-06 02:38:06.196386 :</span></span>
<span id="cb320-16"><a href="archr-and-custom-deviations.html#cb320-16" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb320-17"><a href="archr-and-custom-deviations.html#cb320-17" tabindex="-1"></a><span class="do">## Plotting Embedding</span></span>
<span id="cb320-18"><a href="archr-and-custom-deviations.html#cb320-18" tabindex="-1"></a><span class="do">## 1 2 3 4 </span></span>
<span id="cb320-19"><a href="archr-and-custom-deviations.html#cb320-19" tabindex="-1"></a><span class="do">## ArchR logging successful to : ArchRLogs/ArchR-plotEmbedding-9a35a137-Date-2025-02-06_Time-02-38-04.777479.log</span></span></code></pre></div>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="archr-and-custom-deviations.html#cb321-1" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(p, <span class="cf">function</span>(x){</span>
<span id="cb321-2"><a href="archr-and-custom-deviations.html#cb321-2" tabindex="-1"></a>    x <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">&quot;none&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span> </span>
<span id="cb321-3"><a href="archr-and-custom-deviations.html#cb321-3" tabindex="-1"></a>    <span class="fu">theme_ArchR</span>(<span class="at">baseSize =</span> <span class="fl">6.5</span>) <span class="sc">+</span></span>
<span id="cb321-4"><a href="archr-and-custom-deviations.html#cb321-4" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="st">&quot;cm&quot;</span>)) <span class="sc">+</span></span>
<span id="cb321-5"><a href="archr-and-custom-deviations.html#cb321-5" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb321-6"><a href="archr-and-custom-deviations.html#cb321-6" tabindex="-1"></a>        <span class="at">axis.text.x=</span><span class="fu">element_blank</span>(), </span>
<span id="cb321-7"><a href="archr-and-custom-deviations.html#cb321-7" tabindex="-1"></a>        <span class="at">axis.ticks.x=</span><span class="fu">element_blank</span>(), </span>
<span id="cb321-8"><a href="archr-and-custom-deviations.html#cb321-8" tabindex="-1"></a>        <span class="at">axis.text.y=</span><span class="fu">element_blank</span>(), </span>
<span id="cb321-9"><a href="archr-and-custom-deviations.html#cb321-9" tabindex="-1"></a>        <span class="at">axis.ticks.y=</span><span class="fu">element_blank</span>()</span>
<span id="cb321-10"><a href="archr-and-custom-deviations.html#cb321-10" tabindex="-1"></a>    )</span>
<span id="cb321-11"><a href="archr-and-custom-deviations.html#cb321-11" tabindex="-1"></a>})</span>
<span id="cb321-12"><a href="archr-and-custom-deviations.html#cb321-12" tabindex="-1"></a><span class="fu">do.call</span>(cowplot<span class="sc">::</span>plot_grid, <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">ncol =</span> <span class="dv">2</span>),p2))</span></code></pre></div>
<p><img src="ArchR_files/figure-html/unnamed-chunk-305-1.svg" width="672" /></p>

</div>
</div>
<!-- </div> -->
            </section>

          </div>
        </div>
      </div>
<a href="motif-deviations.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="footprinting-with-archr.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": null
},
"fontsettings": null,
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "none"
},
"info": false
});
});
</script>

</body>

</html>
