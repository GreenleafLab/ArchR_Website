# Labeling Clusters with scRNA

```{r, include=FALSE}
setwd("/Volumes/JG_SSD_2/ArchR_Walkthrough/")
#load("Save-ArchR-Walkthrough-Chapter1-Feb13.Rdata")
save.image("Save-ArchR-Walkthrough-Feb17-0207.Rdata")
```

## Labeling scATAC cells with scRNA clusters

First we need to download scRNA data for hematopoiesis from Granja* et al (2019).

```{r eval=FALSE}
#259 MB Download
if(!file.exists("scRNA-Healthy-Hematopoiesis-191120.rds")){
	download.file(
		url = "https://jeffgranja.s3.amazonaws.com/MPAL-10x/Supplementary_Data/Healthy-Data/scRNA-Healthy-Hematopoiesis-191120.rds",
		destfile = "scRNA-Healthy-Hematopoiesis-191120.rds"
	)
}

seRNA <- readRDS("scRNA-Healthy-Hematopoiesis-191120.rds")
seRNA
# class: RangedSummarizedExperiment 
# dim: 20287 35582 
# metadata(6): variableGenes optimizeLSI ... UMAP_Params colorMap
# assays(1): counts
# rownames(20287): FAM138A OR4F5 ... S100B PRMT2
# rowData names(3): gene_name gene_id exonLength
# colnames(35582): CD34_32_R5:AAACCTGAGTATCGAA-1
#   CD34_32_R5:AAACCTGAGTCGTTTG-1 ...
#   BMMC_10x_GREENLEAF_REP2:TTTGTTGCATGTGTCA-1
#   BMMC_10x_GREENLEAF_REP2:TTTGTTGCATTGAAAG-1
# colData names(10): Group nUMI_pre ... BioClassification Barcode

colnames(colData(seRNA))
# [1] "Group"             "nUMI_pre"          "nUMI"             
# [4] "nGene"             "initialClusters"   "UMAP1"            
# [7] "UMAP2"             "Clusters"          "BioClassification"
# [10] "Barcode"          

table(colData(seRNA)$BioClassification)
#         01_HSC 02_Early.Eryth  03_Late.Eryth  04_Early.Baso    05_CMP.LMPP 
#           1425           1653            446            111           2260 
#       06_CLP.1         07_GMP    08_GMP.Neut         09_pDC         10_cDC 
#            903           2097           1050            544            325 
# 11_CD14.Mono.1 12_CD14.Mono.2   13_CD16.Mono         14_Unk       15_CLP.2 
#           1800           4222            292            520            377 
#       16_Pre.B           17_B      18_Plasma       19_CD8.N      20_CD4.N1 
#            710           1711             62           1521           2470 
#      21_CD4.N2       22_CD4.M      23_CD8.EM      24_CD8.CM          25_NK 
#           2364           3539            796           2080           2143 
#         26_Unk 
#            161 
```

Unconstrained Integration (not-recommended)

```{r eval=FALSE}
#~5 minutes
projHeme2 <- addGeneIntegrationMatrix(
	ArchRProj = projHeme2, 
	seRNA = seRNA, 
	addToArrow = FALSE,
	groupBy = "BioClassification",
	nameGroup = "predictedGroup1",
	nameScore = "predictedScore1"
)
```

Constrained Integration (recommended)

```{r eval=FALSE}

sampleList <- SimpleList(
	scATAC_BMMC_R1 = grep("BMMC", colnames(seRNA), ignore.case = TRUE, value = TRUE),
	scATAC_CD34_BMMC_R1 = grep("CD34", colnames(seRNA), ignore.case = TRUE, value = TRUE),
	scATAC_PBMC_R1 = grep("PBMC", colnames(seRNA), ignore.case = TRUE, value = TRUE)
)

#To see size of each list element
lapply(sampleList, length)
# $scATAC_BMMC_R1
# [1] 12602

# $scATAC_CD34_BMMC_R1
# [1] 8176

# $scATAC_PBMC_R1
# [1] 14804

#~5 minutes
projHeme2 <- addGeneIntegrationMatrix(
	ArchRProj = projHeme2, 
	seRNA = seRNA, 
	sampleList = sampleList,
	addToArrow = FALSE,
	groupBy = "BioClassification",
	nameGroup = "predictedGroup2",
	nameScore = "predictedScore2"
)
```

Compare results

```{r eval=FALSE}
pal <- paletteDiscrete(values = colData(seRNA)$BioClassification)
pal
#         01_HSC 02_Early.Eryth  03_Late.Eryth  04_Early.Baso    05_CMP.LMPP 
#      "#D51F26"      "#502A59"      "#235D55"      "#3D6E57"      "#8D2B8B" 
#       06_CLP.1         07_GMP    08_GMP.Neut         09_pDC         10_cDC 
#      "#DE6C3E"      "#F9B712"      "#D8CE42"      "#8E9ACD"      "#B774B1" 
# 11_CD14.Mono.1 12_CD14.Mono.2   13_CD16.Mono         14_Unk       15_CLP.2 
#      "#D69FC8"      "#C7C8DE"      "#8FD3D4"      "#89C86E"      "#CC9672" 
#       16_Pre.B           17_B      18_Plasma       19_CD8.N      20_CD4.N1 
#      "#CF7E96"      "#A27AA4"      "#CD4F32"      "#6B977E"      "#518AA3" 
#      21_CD4.N2       22_CD4.M      23_CD8.EM      24_CD8.CM          25_NK 
#      "#5A5297"      "#0F707D"      "#5E2E32"      "#A95A3C"      "#B28D5C" 
#         26_Unk 
#      "#3D3D3D"
```

```{r eval=FALSE}
p1 <- plotEmbedding(projHeme2, colorBy = "cellColData", name = "predictedGroup1", pal = pal)
p1
```
![](images/HemeWalkthrough/PNG/Plot-UMAP-RNA-Integration_1.png){width=600 height=600}

```{r eval=FALSE}
p2 <- plotEmbedding(projHeme2, colorBy = "cellColData", name = "predictedGroup2", pal = pal)
p2
```
![](images/HemeWalkthrough/PNG/Plot-UMAP-RNA-Integration_2.png){width=600 height=600}

To save a nice looking pdf we use plotPDF which removes white pages and tries to make the plots
nice looking.

```{r eval=FALSE}
plotPDF(p1,p2, name = "Plot-UMAP-RNA-Integration.pdf", ArchRProj = projHeme2, addDOC = FALSE, width = 5, height = 5)
```

## Adding Pseudo-scRNA profiles for each scATAC cell

First we need to download scRNA data for hematopoiesis from Granja* et al (2019).

```{r eval=FALSE}
#259 MB Download
if(!file.exists("scRNA-Healthy-Hematopoiesis-191120.rds")){
	download.file(
		url = "https://jeffgranja.s3.amazonaws.com/MPAL-10x/Supplementary_Data/Healthy-Data/scRNA-Healthy-Hematopoiesis-191120.rds",
		destfile = "scRNA-Healthy-Hematopoiesis-191120.rds"
	)
}

seRNA <- readRDS("scRNA-Healthy-Hematopoiesis-191120.rds")
seRNA
# class: RangedSummarizedExperiment 
# dim: 20287 35582 
# metadata(6): variableGenes optimizeLSI ... UMAP_Params colorMap
# assays(1): counts
# rownames(20287): FAM138A OR4F5 ... S100B PRMT2
# rowData names(3): gene_name gene_id exonLength
# colnames(35582): CD34_32_R5:AAACCTGAGTATCGAA-1
#   CD34_32_R5:AAACCTGAGTCGTTTG-1 ...
#   BMMC_10x_GREENLEAF_REP2:TTTGTTGCATGTGTCA-1
#   BMMC_10x_GREENLEAF_REP2:TTTGTTGCATTGAAAG-1
# colData names(10): Group nUMI_pre ... BioClassification Barcode

colnames(colData(seRNA))
# [1] "Group"             "nUMI_pre"          "nUMI"             
# [4] "nGene"             "initialClusters"   "UMAP1"            
# [7] "UMAP2"             "Clusters"          "BioClassification"
# [10] "Barcode"          

table(colData(seRNA)$BioClassification)
#         01_HSC 02_Early.Eryth  03_Late.Eryth  04_Early.Baso    05_CMP.LMPP 
#           1425           1653            446            111           2260 
#       06_CLP.1         07_GMP    08_GMP.Neut         09_pDC         10_cDC 
#            903           2097           1050            544            325 
# 11_CD14.Mono.1 12_CD14.Mono.2   13_CD16.Mono         14_Unk       15_CLP.2 
#           1800           4222            292            520            377 
#       16_Pre.B           17_B      18_Plasma       19_CD8.N      20_CD4.N1 
#            710           1711             62           1521           2470 
#      21_CD4.N2       22_CD4.M      23_CD8.EM      24_CD8.CM          25_NK 
#           2364           3539            796           2080           2143 
#         26_Unk 
#            161 
```

We can now save our original projHeme2 using `saveArchRProject` from ArchR.

```{r eval=FALSE}
saveArchRProject(projHeme2)
```

Constrained Integration (recommended)

```{r eval=FALSE}

sampleList <- SimpleList(
	scATAC_BMMC_R1 = grep("BMMC", colnames(seRNA), ignore.case = TRUE, value = TRUE),
	scATAC_CD34_BMMC_R1 = grep("CD34", colnames(seRNA), ignore.case = TRUE, value = TRUE),
	scATAC_PBMC_R1 = grep("PBMC", colnames(seRNA), ignore.case = TRUE, value = TRUE)
)

#To see size of each list element
lapply(sampleList, length)
# $scATAC_BMMC_R1
# [1] 12602

# $scATAC_CD34_BMMC_R1
# [1] 8176

# $scATAC_PBMC_R1
# [1] 14804

#~5 minutes
projHeme3 <- addGeneIntegrationMatrix(
	ArchRProj = projHeme2, 
	seRNA = seRNA, 
	sampleList = sampleList,
	addToArrow = TRUE, # We are going to add scRNA to each Arrow
	groupBy = "BioClassification",
	nameGroup = "predictedGroup",
	nameScore = "predictedScore"
)
```

What matrices are available?

```{r eval=FALSE}
getAvailableMatrices(projHeme3)
#[1] "GeneIntegrationMatrix" "GeneScoreMatrix"       "TileMatrix"
```

Now lets see how this effects our marker gene scores overlayed on our 2-d embedding.

```{r eval=FALSE}
markerGenes  <- c(
    "CD34", #Early Progenitor
    "GATA1", #Erythroid
    "PAX5", "MS4A1", #B-Cell Trajectory
    "CD14", #Monocytes
    "CD3D", "CD8A", "TBX21", "IL7R" #TCells
  )

p1 <- plotEmbedding(
    ArchRProj = projHeme3, 
    colorBy = "GeneIntegrationMatrix", 
    name = markerGenes, 
    continuousSet = "horizonExtra",
    embedding = "UMAP",
    imputeWeights = getImputeWeights(projHeme3)
)

p2 <- plotEmbedding(
    ArchRProj = projHeme3, 
    colorBy = "GeneScoreMatrix", 
    continuousSet = "horizonExtra",
    name = markerGenes, 
    embedding = "UMAP",
    imputeWeights = getImputeWeights(projHeme3)
)
```

To plot all marker genes we can use cowplot

```{r, eval = FALSE}
#Rearrange for grid plotting
p1c <- lapply(p1, function(x){
    x + guides(color = FALSE, fill = FALSE) + 
    theme_ArchR(baseSize = 6.5) +
    theme(plot.margin = unit(c(0, 0, 0, 0), "cm")) +
    theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank()
    )
})

#Rearrange for grid plotting
p2c <- lapply(p2, function(x){
    x + guides(color = FALSE, fill = FALSE) + 
    theme_ArchR(baseSize = 6.5) +
    theme(plot.margin = unit(c(0, 0, 0, 0), "cm")) +
    theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank()
    )
})

do.call(cowplot::plot_grid, c(list(ncol = 3), p1c))
```

![](images/HemeWalkthrough/PNG/Plot-UMAP-Markers-RNA-W-Imputation_1.png){width=800 height=800}


```{r, eval = FALSE}
do.call(cowplot::plot_grid, c(list(ncol = 3), p2c))
```

![](images/HemeWalkthrough/PNG/Plot-UMAP-Markers-RNA-W-Imputation_2.png){width=800 height=800}

```{r, include=FALSE, eval = FALSE}
plotPDF(
    do.call(cowplot::plot_grid, c(list(ncol = 3),p1c)), 
    do.call(cowplot::plot_grid, c(list(ncol = 3),p2c)), 
    name = "Plot-UMAP-Markers-RNA-W-Imputation.pdf", 
    ArchRProj = projHeme3,
    addDOC = FALSE,
    width = 10, 
    height = 10
)
```

To save a nice looking pdf we use plotPDF which removes white pages and tries to make the plots
nice looking.

```{r eval=FALSE}
plotPDF(plotList = p1, 
    name = "Plot-UMAP-Marker-Genes-RNA-W-Imputation.pdf", 
    ArchRProj = projHeme3, 
    addDOC = FALSE, width = 5, height = 5)
```

## Labeling scATAC clusters with scRNA

Now that we have pretty good scRNA and scATAC correspondence we can label our clusters with scRNA

```{r, include=FALSE, eval = FALSE}

cm <- as.matrix(ArchR:::.confusionMatrix(projHeme3$Clusters, projHeme3$predictedGroup))
labelOld <- rownames(cm)
#  [1] "Cluster11" "Cluster2"  "Cluster12" "Cluster1"  "Cluster8"  "Cluster4" 
#  [7] "Cluster9"  "Cluster5"  "Cluster7"  "Cluster14" "Cluster3"  "Cluster10"
# [13] "Cluster6"  "Cluster13"
labelNew <- colnames(cm)[apply(cm, 1, which.max)]
labelNew2 <- stringr::str_split(labelNew, pattern = "\\_", simplify = TRUE)[,2]
labelNew3 <- paste0(gsub("Cluster", "C", labelOld), "_", labelNew2)
labelNew3
#  [1] "C11_B"           "C2_CD4.N1"       "C12_Pre.B"       "C1_Early.Eryth" 
#  [5] "C8_GMP.Neut"     "C4_NK"           "C9_CD14.Mono.1"  "C5_Late.Eryth"  
#  [9] "C7_CMP.LMPP"     "C14_pDC"         "C3_CD4.N2"       "C10_CD14.Mono.2"
# [13] "C6_HSC"          "C13_CLP.2" 

projHeme3$Clusters2 <- mapLabels(projHeme3$Clusters, newLabels = labelNew3, oldLabels = labelOld)

p1 <- plotEmbedding(projHeme3, colorBy = "cellColData", name = "Clusters2")
p1
```

To save a nice looking pdf we use plotPDF which removes white pages and tries to make the plots
nice looking.

```{r eval=FALSE}
plotPDF(p1, name = "Plot-UMAP-Remap-Clusters.pdf", ArchRProj = projHeme2, addDOC = FALSE, width = 5, height = 5)
```

![](images/HemeWalkthrough/PNG/Plot-UMAP-Remap-Clusters_1.png){width=500 height=500}







