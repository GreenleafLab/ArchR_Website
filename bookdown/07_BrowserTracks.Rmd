# Marker Genes with scATAC

```{r, include=FALSE}
setwd("/Volumes/JG_SSD_2/ArchR_Walkthrough/")
#load("Save-ArchR-Walkthrough-Chapter1-Feb13.Rdata")
save.image("Save-ArchR-Walkthrough-Feb13-2307.Rdata")
```

## Identification of Marker Genes

Identify Marker Gene through Pairwise Test vs Bias-Matched Background

```{r eval=FALSE}
markersGS <- markerFeatures(
    ArchRProj = projHemeND, 
    useMatrix = "GeneScoreMatrix", 
    groupBy = "Clusters",
    bias = c("TSSEnrichment", "log10(nFrags)"),
    testMethod = "wilcoxon"
)
```

```{r eval=FALSE}
markerList <- getMarkers(markersGS, cutOff = "FDR <= 0.01 & Log2FC >= 1.25")
markerList$Cluster4
# DataFrame with 210 rows and 6 columns
#       seqnames     start           name     idx           Log2FC
#          <Rle>   <array>        <array> <array>        <numeric>
# 14759    chr22  37545962          IL2RB     301 2.09731361787433
# 6856     chr14  99737822         BCL11B     595 1.42193213075962
# 13123     chr2 192038902          STAT4    1064 1.90075014141832
# 12597     chr2  87035519           CD8A     538 1.96747880033344
# 9299     chr17  34207377           CCL5     540 2.65385587389937
# ...        ...       ...            ...     ...              ...
# 1488      chr1 156182779           PMF1    1488 1.35708770978464
# 22735     chrX 101854276 ARMCX5-GPRASP2     518 1.59283344451927
# 19680     chr7  45144641        SNORA5C     318 1.27027443652085
# 1856      chr1 196659182          CFHR4    1856 1.92661384224492
# 17830     chr5 140739703        PCDHGB2     690 2.93899133419389
```

We can then plot this as a heatmap

```{r eval=FALSE}
markerGenes  <- c(
    "CD34", #Early Progenitor
    "GATA1", #Erythroid
    "PAX5", "MS4A1", #B-Cell Trajectory
    "CD14", #Monocytes
    "CD3D", "CD8A", "TBX21", "IL7R" #TCells
  )

heatmapGS <- markerHeatmap(
  seMarker = markersGS, 
  cutOff = "FDR <= 0.01 & Log2FC >= 1.25", 
  labelMarkers = markerGenes,
  transpose = TRUE
)

draw(heatmapGS, heatmap_legend_side = "bot", annotation_legend_side = "bot")
```

We can then plot this 

```{r eval=FALSE}
plotPDF(heatmapGS, name = "GeneScores-Marker-Heatmap", width = 9, height = 7, ArchRProj = projHemeND, addDOC = FALSE)
```

## Marker Genes

```{r eval=FALSE}
markerGenes  <- c(
    "CD34", #Early Progenitor
    "GATA1", #Erythroid
    "PAX5", "MS4A1", #B-Cell Trajectory
    "CD14", #Monocytes
    "CD3D", "CD8A", "TBX21", "IL7R" #TCells
  )

p <- plotEmbedding(
    ArchRProj = projHemeND, 
    colorBy = "GeneScoreMatrix", 
    name = markerGenes, 
    embedding = "UMAP",
    quantCut = c(0.01, 0.95),
    imputeWeights = NULL
)
```

To plot a specific gene try

```{r, include=FALSE, eval = FALSE}
p$CD14
```

To plot all genes we can use cowplot

```{r, include=FALSE, eval = FALSE}
#Rearrange for grid plotting
p2 <- lapply(p, function(x){
    x + guides(color = FALSE, fill = FALSE) + 
    theme_ArchR(baseSize = 6.5) +
    theme(plot.margin = unit(c(0, 0, 0, 0), "cm")) +
    theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank()
    )
})
do.call(cowplot::plot_grid, c(list(ncol = 3),p2))
```

```{r, include=FALSE, eval = FALSE}
plotPDF(
    do.call(cowplot::plot_grid, c(list(ncol = 3),p2)), 
    name = "Plot-UMAP-Markers-WO-Imputation.pdf", 
    ArchRProj = projHemeND,
    addDOC = FALSE,
    width = 10, 
    height = 10
)
```

To save a nice looking pdf we use plotPDF which removes white pages and tries to make the plots
nice looking.

```{r eval=FALSE}
plotPDF(plotList = p, 
    name = "Plot-UMAP-Marker-Genes-WO-Imputation.pdf", 
    ArchRProj = projHemeND, 
    addDOC = FALSE, width = 5, height = 5)
```


## Marker Genes with Imputation 


```{r eval=FALSE}
projHemeND <- addImputeWeights(projHemeND)
markerGenes  <- c(
    "CD34", #Early Progenitor
    "GATA1", #Erythroid
    "PAX5", "MS4A1", #B-Cell Trajectory
    "CD14", #Monocytes
    "CD3D", "CD8A", "TBX21", "IL7R" #TCells
  )

p <- plotEmbedding(
    ArchRProj = projHemeND, 
    colorBy = "GeneScoreMatrix", 
    name = markerGenes, 
    embedding = "UMAP",
    imputeWeights = getImputeWeights(projHemeND)
)
```

To plot a specific gene try

```{r, include=FALSE, eval = FALSE}
p$CD14
```

To plot all genes we can use cowplot

```{r, include=FALSE, eval = FALSE}
#Rearrange for grid plotting
p2 <- lapply(p, function(x){
    x + guides(color = FALSE, fill = FALSE) + 
    theme_ArchR(baseSize = 6.5) +
    theme(plot.margin = unit(c(0, 0, 0, 0), "cm")) +
    theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank()
    )
})
do.call(cowplot::plot_grid, c(list(ncol = 3),p2))
```

```{r, include=FALSE, eval = FALSE}
plotPDF(
    do.call(cowplot::plot_grid, c(list(ncol = 3),p2)), 
    name = "Plot-UMAP-Markers-W-Imputation.pdf", 
    ArchRProj = projHemeND,
    addDOC = FALSE,
    width = 10, 
    height = 10
)
```

To save a nice looking pdf we use plotPDF which removes white pages and tries to make the plots
nice looking.

```{r eval=FALSE}
plotPDF(plotList = p, 
    name = "Plot-UMAP-Marker-Genes-W-Imputation.pdf", 
    ArchRProj = projHemeND, 
    addDOC = FALSE, width = 5, height = 5)
```










